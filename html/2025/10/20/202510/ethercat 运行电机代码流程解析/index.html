<!DOCTYPE html>
<html lang="zh-Hans">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <meta name="description" content="ethercat 运行电机代码流程解析" />
    <meta name="hexo-theme-A4" content="v1.7.0" />
    <link rel="alternate icon" type="image/webp" href="/img/favicon.webp">
    <title>CallMeTommy的博客 | 代码和生活</title>

    
        
<link rel="stylesheet" href="/css/highlight/style1.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--注意：首页既不是post也不是page-->
        
            
<link rel="stylesheet" href="/css/waline.css">

        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--返回顶部css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--目录-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    

    
        
<link rel="stylesheet" href="/css/returnToLastPage.css">

    
    
   
<link rel="stylesheet" href="/css/lightgallery-bundle.min.css">


<meta name="generator" content="Hexo 7.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><link rel="alternate" href="/atom.xml" title="CallMeTommy的博客" type="application/atom+xml">
</head>
    
    

    
    



    

    
    

    
    
    
    <body>
        <script src="/js/darkmode-js.min.js"></script>
        
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    


<div class="header">
    <div class="header-container">
        <img style="
        width: 56px;
        height: auto;" alt="^-^" cache-control="max-age=86400" class="header-img" src="/img/favicon.webp" width="10%"></img>
        <div class="header-content">
            <a class="logo" href="/">CallMeTommy的博客</a> 
            <span class="description">杂乱写东西的地方</span> 
        </div>
        
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">首页</a></li>
            
        
            
                <li><a href="/list/">文章</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--说明是文章post页面-->
                    
                        <div class="post-main">
    

    
        
            
                <div class="post-main-title" style="text-align: center;">
                    ethercat 运行电机代码流程解析
                </div>
            
        
      
    

    

        
            <div class="post-head-meta-center">
        
                
                    <span>最近更新：2025-10-20</span> 
                
                
                    
                        &nbsp; | &nbsp;
                    
                     <span>字数总计：4.8k</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span>阅读估时：24分钟</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span id="busuanzi_container_page_pv">
                        阅读量：<span id="busuanzi_value_page_pv"></span>次
                    </span>
                
            </div>
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#ethercat-%E8%BF%90%E8%A1%8C%E7%94%B5%E6%9C%BA%E4%BB%A3%E7%A0%81%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90"><span class="post-toc-text">ethercat 运行电机代码流程解析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%89%8D%E6%8F%90"><span class="post-toc-text">前提</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%89%8D%E6%8F%90%E9%85%8D%E7%BD%AE"><span class="post-toc-text">前提配置</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%8E%B7%E5%8F%96%E4%B8%BB%E7%AB%99%E5%92%8C%E4%BB%8E%E7%AB%99%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="post-toc-text">获取主站和从站的基本信息</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%BB%8E%E7%AB%99%E7%9A%84%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE"><span class="post-toc-text">从站的基本配置</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#PDO"><span class="post-toc-text">PDO</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#DC%E8%AE%BE%E7%BD%AE"><span class="post-toc-text">DC设置</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ecrt-domain-reg-pdo-entry-list"><span class="post-toc-text">ecrt_domain_reg_pdo_entry_list</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%B8%80%E4%BA%9B%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE"><span class="post-toc-text">一些核心配置</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%BF%80%E6%B4%BB%E4%B8%BB%E7%AB%99"><span class="post-toc-text">激活主站</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%BF%87%E7%A8%8B%E6%95%B0%E6%8D%AE%E6%8C%87%E9%92%88"><span class="post-toc-text">过程数据指针</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%BC%80%E5%A7%8B%E5%BE%AA%E7%8E%AF"><span class="post-toc-text">开始循环</span></a></li></ol></li></ol></li></ol>
            
        
        <div class=".article-gallery"><h1 id="ethercat-运行电机代码流程解析"><a href="#ethercat-运行电机代码流程解析" class="headerlink" title="ethercat 运行电机代码流程解析"></a>ethercat 运行电机代码流程解析</h1><h3 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h3><p>目前是C开发的代码，基于ethercat 1.6.x 版本使用</p>
<p>到现在为止没有发现 1.6.x 不兼容的情况。</p>
<p>明确不兼容 1.5.x</p>
<h3 id="前提配置"><a href="#前提配置" class="headerlink" title="前提配置"></a>前提配置</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过索引连接 ethercat主站</span></span><br><span class="line"><span class="type">ec_master_t</span> *master = <span class="built_in">ecrt_request_master</span>(master_index);</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建域，PDO 的过程数据通道</span></span><br><span class="line"><span class="type">ec_domain_t</span> *domain = <span class="built_in">ecrt_master_create_domain</span>(master);</span><br></pre></td></tr></table></figure>
<p>输入索引，创建域</p>
<h3 id="获取主站和从站的基本信息"><a href="#获取主站和从站的基本信息" class="headerlink" title="获取主站和从站的基本信息"></a>获取主站和从站的基本信息</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ethercat/include/ecrt.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> {</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> slave_count; <span class="comment">/**&lt; Number of slaves in the network. */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> link_up : <span class="number">1</span>; <span class="comment">/**&lt; \a true, if the network link is up. */</span></span><br><span class="line">    <span class="type">uint8_t</span> scan_busy; <span class="comment">/**&lt; \a true, while the master is scanning the network.</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">    <span class="type">uint64_t</span> app_time; <span class="comment">/**&lt; Application time. */</span></span><br><span class="line">} <span class="type">ec_master_info_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">ec_master_info_t</span> master_info;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">ecrt_master</span>(master, &amp;master_info)) {}</span><br><span class="line"> <span class="type">size_t</span> num_slaves = master_info.slave_count;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取从站信息</span></span><br><span class="line"><span class="comment">//对象信息如下</span></span><br><span class="line"><span class="comment">//ethercat/include/ecrt.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> {</span><br><span class="line">    <span class="type">uint16_t</span> position; <span class="comment">/**&lt; Offset of the slave in the ring. */</span></span><br><span class="line">    <span class="type">uint32_t</span> vendor_id; <span class="comment">/**&lt; Vendor-ID stored on the slave. */</span></span><br><span class="line">    <span class="type">uint32_t</span> product_code; <span class="comment">/**&lt; Product-Code stored on the slave. */</span></span><br><span class="line">    <span class="type">uint32_t</span> revision_number; <span class="comment">/**&lt; Revision-Number stored on the slave. */</span></span><br><span class="line">    <span class="type">uint32_t</span> serial_number; <span class="comment">/**&lt; Serial-Number stored on the slave. */</span></span><br><span class="line">    <span class="type">uint16_t</span> alias; <span class="comment">/**&lt; The slaves alias if not equal to 0. */</span></span><br><span class="line">    <span class="type">int16_t</span> current_on_ebus; <span class="comment">/**&lt; Used current in mA. */</span></span><br><span class="line">    <span class="keyword">struct</span> {</span><br><span class="line">        <span class="type">ec_slave_port_desc_t</span> desc; <span class="comment">/**&lt; Physical port type. */</span></span><br><span class="line">        <span class="type">ec_slave_port_link_t</span> link; <span class="comment">/**&lt; Port link state. */</span></span><br><span class="line">        <span class="type">uint32_t</span> receive_time; <span class="comment">/**&lt; Receive time on DC transmission delay</span></span><br><span class="line"><span class="comment">                                 measurement. */</span></span><br><span class="line">        <span class="type">uint16_t</span> next_slave; <span class="comment">/**&lt; Ring position of next DC slave on that</span></span><br><span class="line"><span class="comment">                               port.  */</span></span><br><span class="line">        <span class="type">uint32_t</span> delay_to_next_dc; <span class="comment">/**&lt; Delay [ns] to next DC slave. */</span></span><br><span class="line">    } ports[EC_MAX_PORTS]; <span class="comment">/**&lt; Port information. */</span></span><br><span class="line">    <span class="type">uint8_t</span> al_state; <span class="comment">/**&lt; Current state of the slave. */</span></span><br><span class="line">    <span class="type">uint8_t</span> error_flag; <span class="comment">/**&lt; Error flag for that slave. */</span></span><br><span class="line">    <span class="type">uint8_t</span> sync_count; <span class="comment">/**&lt; Number of sync managers. */</span></span><br><span class="line">    <span class="type">uint16_t</span> sdo_count; <span class="comment">/**&lt; Number of SDOs. */</span></span><br><span class="line">    <span class="type">char</span> name[EC_MAX_STRING_LENGTH]; <span class="comment">/**&lt; Name of the slave. */</span></span><br><span class="line">} <span class="type">ec_slave_info_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//具体的获取方法</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">ecrt_master_get_slave</span>(master, i, &amp;info[i]) &lt; <span class="number">0</span>)</span><br><span class="line">{</span><br><span class="line">    <span class="built_in">LOG_ERROR</span>(<span class="string">"未找到从站 %zu，请检查连接\n"</span>, i);</span><br><span class="line">    <span class="built_in">ecrt_release_master</span>(master);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>这一步其实也是获取基本信息。有几个从站，能拿到主站和从站的对象</p>
<h3 id="从站的基本配置"><a href="#从站的基本配置" class="headerlink" title="从站的基本配置"></a>从站的基本配置</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//配置从站, 这一步只是“拿到从站配置句柄”。返回值就是一个 ec_slave_config_t*，后续你再用它去做 PDO/SDO/DC 等配置</span></span><br><span class="line"><span class="comment">//下面是对象</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ec_slave_config</span> {</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">list_head</span> list; <span class="comment">/**&lt; List item. */</span></span><br><span class="line">    <span class="type">ec_master_t</span> *master; <span class="comment">/**&lt; Master owning the slave configuration. */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint16_t</span> alias; <span class="comment">/**&lt; Slave alias. */</span></span><br><span class="line">    <span class="type">uint16_t</span> position; <span class="comment">/**&lt; Index after alias. If alias is zero, this is the</span></span><br><span class="line"><span class="comment">                         ring position. */</span></span><br><span class="line">    <span class="type">uint32_t</span> vendor_id; <span class="comment">/**&lt; Slave vendor ID. */</span></span><br><span class="line">    <span class="type">uint32_t</span> product_code; <span class="comment">/**&lt; Slave product code. */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint16_t</span> watchdog_divider; <span class="comment">/**&lt; Watchdog divider as a number of 40ns</span></span><br><span class="line"><span class="comment">                                 intervals (see spec. reg. 0x0400). */</span></span><br><span class="line">    <span class="type">uint16_t</span> watchdog_intervals; <span class="comment">/**&lt; Process data watchdog intervals (see</span></span><br><span class="line"><span class="comment">                                   spec. reg. 0x0420). */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">ec_slave_t</span> *slave; <span class="comment">/**&lt; Slave pointer. This is \a NULL, if the slave is</span></span><br><span class="line"><span class="comment">                         offline. */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">ec_sync_config_t</span> sync_configs[EC_MAX_SYNC_MANAGERS]; <span class="comment">/**&lt; Sync manager</span></span><br><span class="line"><span class="comment">                                                   configurations. */</span></span><br><span class="line">    <span class="type">ec_fmmu_config_t</span> fmmu_configs[EC_MAX_FMMUS]; <span class="comment">/**&lt; FMMU configurations. */</span></span><br><span class="line">    <span class="type">uint8_t</span> used_fmmus; <span class="comment">/**&lt; Number of FMMUs used. */</span></span><br><span class="line">    <span class="type">uint16_t</span> dc_assign_activate; <span class="comment">/**&lt; Vendor-specific AssignActivate word. */</span></span><br><span class="line">    <span class="type">ec_sync_signal_t</span> dc_sync[EC_SYNC_SIGNAL_COUNT]; <span class="comment">/**&lt; DC sync signals. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">list_head</span> sdo_configs; <span class="comment">/**&lt; List of SDO configurations. */</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">list_head</span> sdo_requests; <span class="comment">/**&lt; List of SDO requests. */</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">list_head</span> soe_requests; <span class="comment">/**&lt; List of SoE requests. */</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">list_head</span> voe_handlers; <span class="comment">/**&lt; List of VoE handlers. */</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">list_head</span> reg_requests; <span class="comment">/**&lt; List of register requests. */</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">list_head</span> soe_configs; <span class="comment">/**&lt; List of SoE configurations. */</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">list_head</span> flags; <span class="comment">/**&lt; List of feature flags. */</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">list_head</span> al_timeouts; <span class="comment">/**&lt; List of specific AL state timeouts. */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> EC_EOE</span></span><br><span class="line">    <span class="type">ec_eoe_request_t</span> eoe_ip_param_request; <span class="comment">/**&lt; EoE IP parameters. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">ec_coe_emerg_ring_t</span> emerg_ring; <span class="comment">/**&lt; CoE emergency ring buffer. */</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">//下面是具体操作方法</span></span><br><span class="line">sc[i] = <span class="built_in">ecrt_master_slave_config</span>(master, info[i].alias, info[i].position, info[i].vendor_id, info[i].product_code);</span><br></pre></td></tr></table></figure>
<p>这里其实是创建了从站的配置.</p>
<h3 id="PDO"><a href="#PDO" class="headerlink" title="PDO"></a>PDO</h3><p>这里开始就比较关键了。</p>
<p>有两种方式可以拿到从站的配置信息</p>
<ol>
<li>ethercat xml -p -m</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">user@ak41-ubuntu:~$ ethercat xml -m3 -p0</span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">EtherCATInfo</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Slave 0 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Vendor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Id</span>&gt;</span>4247<span class="tag">&lt;/<span class="name">Id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Vendor</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Descriptions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Devices</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Device</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Type</span> <span class="attr">ProductCode</span>=<span class="string">"#x00002406"</span> <span class="attr">RevisionNo</span>=<span class="string">"#x0000008f"</span>&gt;</span>EYOU_ServoModule_V143<span class="tag">&lt;/<span class="name">Type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Name</span>&gt;</span>&lt;![CDATA[EYOU_ServoModule_ECAT_V143]]&gt;<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Sm</span> <span class="attr">Enable</span>=<span class="string">"1"</span> <span class="attr">StartAddress</span>=<span class="string">"#x1000"</span> <span class="attr">ControlByte</span>=<span class="string">"#x26"</span> <span class="attr">DefaultSize</span>=<span class="string">"128"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Sm</span> <span class="attr">Enable</span>=<span class="string">"1"</span> <span class="attr">StartAddress</span>=<span class="string">"#x1100"</span> <span class="attr">ControlByte</span>=<span class="string">"#x22"</span> <span class="attr">DefaultSize</span>=<span class="string">"128"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Sm</span> <span class="attr">Enable</span>=<span class="string">"1"</span> <span class="attr">StartAddress</span>=<span class="string">"#x1200"</span> <span class="attr">ControlByte</span>=<span class="string">"#x64"</span> <span class="attr">DefaultSize</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Sm</span> <span class="attr">Enable</span>=<span class="string">"1"</span> <span class="attr">StartAddress</span>=<span class="string">"#x1300"</span> <span class="attr">ControlByte</span>=<span class="string">"#x20"</span> <span class="attr">DefaultSize</span>=<span class="string">"14"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">RxPdo</span> <span class="attr">Sm</span>=<span class="string">"2"</span> <span class="attr">Fixed</span>=<span class="string">"1"</span> <span class="attr">Mandatory</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">Index</span>&gt;</span>#x1600<span class="tag">&lt;/<span class="name">Index</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">Name</span>&gt;</span>csp/csv/cst RxPDO<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">Entry</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Index</span>&gt;</span>#x6040<span class="tag">&lt;/<span class="name">Index</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">SubIndex</span>&gt;</span>0<span class="tag">&lt;/<span class="name">SubIndex</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">BitLen</span>&gt;</span>16<span class="tag">&lt;/<span class="name">BitLen</span>&gt;</span></span><br><span class="line">....</span><br></pre></td></tr></table></figure>
<p>他就会把从站的ESI信息给你，你就可以完全按照这个来操作.</p>
<p>但是… 这里有一个坑。</p>
<p>首先这是是不全的，他只是厂商的默认的。</p>
<p>有的厂商默认的比较好，有的厂商默认的比较差。所以光看这个是看运气的。</p>
<p>因为之前想要做一个通过 ESI文件自适应，让电机能直接跑的工具。</p>
<p>直接上了 <code>ethercat xml</code>  导致了后续的很多问题，目前都还没有去修改回ESI文件，因为没时间</p>
<p>另外就是有些电机厂商对于ESI文件分的比较细，按照我的想法，所有都允许传就行了，我遇见过最极端的分了30多个…</p>
<p>为什么真多个我不理解，ESI文件都给我看的脑袋疼。</p>
<p>所以建议还是第二种方法.</p>
<p><strong>ESI文件分析</strong></p>
<p>这个我已经写了一篇ESI文件简单结构和内容的文章, 需要的可以查一下</p>
<p>基本开发基本ok，但是需要Ethercat官方那个文件，需要边搞边查.</p>
<p>我就拿我其中一台来举例子了</p>
<p><a href="https://blog.callmetommy.cn/2025/08/05/202507/ethercat_yundong_model/">https://blog.callmetommy.cn/2025/08/05/202507/ethercat_yundong_model/</a></p>
<p>这个是我之前写的文章</p>
<p>现在我列出EYOU电机的ESI部分</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">RxPdo</span> <span class="attr">Fixed</span>=<span class="string">"0"</span> <span class="attr">Sm</span>=<span class="string">"2"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Index</span> <span class="attr">DependOnSlot</span>=<span class="string">"true"</span>&gt;</span>#x1600<span class="tag">&lt;/<span class="name">Index</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Exclude</span>&gt;</span>#x1601<span class="tag">&lt;/<span class="name">Exclude</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Exclude</span>&gt;</span>#x1602<span class="tag">&lt;/<span class="name">Exclude</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Name</span> <span class="attr">LcId</span>=<span class="string">"1033"</span>&gt;</span>Outputs<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Entry</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Index</span> <span class="attr">DependOnSlot</span>=<span class="string">"true"</span>&gt;</span>#x6040<span class="tag">&lt;/<span class="name">Index</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">SubIndex</span>&gt;</span>0<span class="tag">&lt;/<span class="name">SubIndex</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">BitLen</span>&gt;</span>16<span class="tag">&lt;/<span class="name">BitLen</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Name</span> <span class="attr">LcId</span>=<span class="string">"1033"</span>&gt;</span>Control Word<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Comment</span>&gt;</span>object 0x6040:0<span class="tag">&lt;/<span class="name">Comment</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">DataType</span>&gt;</span>UINT<span class="tag">&lt;/<span class="name">DataType</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">Entry</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Entry</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Index</span> <span class="attr">DependOnSlot</span>=<span class="string">"true"</span>&gt;</span>#x607A<span class="tag">&lt;/<span class="name">Index</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">SubIndex</span>&gt;</span>0<span class="tag">&lt;/<span class="name">SubIndex</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">BitLen</span>&gt;</span>32<span class="tag">&lt;/<span class="name">BitLen</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Name</span> <span class="attr">LcId</span>=<span class="string">"1033"</span>&gt;</span>Target Position<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Comment</span>&gt;</span>object 0x607A:0<span class="tag">&lt;/<span class="name">Comment</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">DataType</span>&gt;</span>DINT<span class="tag">&lt;/<span class="name">DataType</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">Entry</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Entry</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Index</span> <span class="attr">DependOnSlot</span>=<span class="string">"true"</span>&gt;</span>#x60FF<span class="tag">&lt;/<span class="name">Index</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">SubIndex</span>&gt;</span>0<span class="tag">&lt;/<span class="name">SubIndex</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">BitLen</span>&gt;</span>32<span class="tag">&lt;/<span class="name">BitLen</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Name</span> <span class="attr">LcId</span>=<span class="string">"1033"</span>&gt;</span>Target Velocity<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Comment</span>&gt;</span>object 0x60FF:0<span class="tag">&lt;/<span class="name">Comment</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">DataType</span>&gt;</span>DINT<span class="tag">&lt;/<span class="name">DataType</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">Entry</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Entry</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Index</span> <span class="attr">DependOnSlot</span>=<span class="string">"true"</span>&gt;</span>#x6071<span class="tag">&lt;/<span class="name">Index</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">SubIndex</span>&gt;</span>0<span class="tag">&lt;/<span class="name">SubIndex</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">BitLen</span>&gt;</span>16<span class="tag">&lt;/<span class="name">BitLen</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Name</span> <span class="attr">LcId</span>=<span class="string">"1033"</span>&gt;</span>Target Torque<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Comment</span>&gt;</span>object 0x6071:0<span class="tag">&lt;/<span class="name">Comment</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">DataType</span>&gt;</span>INT<span class="tag">&lt;/<span class="name">DataType</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">Entry</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Entry</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Index</span> <span class="attr">DependOnSlot</span>=<span class="string">"true"</span>&gt;</span>#x6060<span class="tag">&lt;/<span class="name">Index</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">SubIndex</span>&gt;</span>0<span class="tag">&lt;/<span class="name">SubIndex</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">BitLen</span>&gt;</span>8<span class="tag">&lt;/<span class="name">BitLen</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Name</span> <span class="attr">LcId</span>=<span class="string">"1033"</span>&gt;</span>Mode Of Operation<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Comment</span>&gt;</span>object 0x6060:0<span class="tag">&lt;/<span class="name">Comment</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">DataType</span>&gt;</span>SINT<span class="tag">&lt;/<span class="name">DataType</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">Entry</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Entry</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Index</span>&gt;</span>#x0<span class="tag">&lt;/<span class="name">Index</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">SubIndex</span>&gt;</span>0<span class="tag">&lt;/<span class="name">SubIndex</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">BitLen</span>&gt;</span>8<span class="tag">&lt;/<span class="name">BitLen</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">Entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">RxPdo</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">TxPdo</span> <span class="attr">Fixed</span>=<span class="string">"0"</span> <span class="attr">Sm</span>=<span class="string">"3"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Index</span> <span class="attr">DependOnSlot</span>=<span class="string">"true"</span>&gt;</span>#x1a00<span class="tag">&lt;/<span class="name">Index</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Exclude</span>&gt;</span>#x1a01<span class="tag">&lt;/<span class="name">Exclude</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Exclude</span>&gt;</span>#x1a02<span class="tag">&lt;/<span class="name">Exclude</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Name</span> <span class="attr">LcId</span>=<span class="string">"1033"</span>&gt;</span>Inputs<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Entry</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Index</span> <span class="attr">DependOnSlot</span>=<span class="string">"true"</span>&gt;</span>#x6041<span class="tag">&lt;/<span class="name">Index</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">SubIndex</span>&gt;</span>0<span class="tag">&lt;/<span class="name">SubIndex</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">BitLen</span>&gt;</span>16<span class="tag">&lt;/<span class="name">BitLen</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Name</span> <span class="attr">LcId</span>=<span class="string">"1033"</span>&gt;</span>Status Word<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Comment</span>&gt;</span>object 0x6041:0<span class="tag">&lt;/<span class="name">Comment</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">DataType</span>&gt;</span>UINT<span class="tag">&lt;/<span class="name">DataType</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">Entry</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Entry</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Index</span> <span class="attr">DependOnSlot</span>=<span class="string">"true"</span>&gt;</span>#x6064<span class="tag">&lt;/<span class="name">Index</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">SubIndex</span>&gt;</span>0<span class="tag">&lt;/<span class="name">SubIndex</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">BitLen</span>&gt;</span>32<span class="tag">&lt;/<span class="name">BitLen</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Name</span> <span class="attr">LcId</span>=<span class="string">"1033"</span>&gt;</span>Actual Position<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Comment</span>&gt;</span>object 0x6064:0<span class="tag">&lt;/<span class="name">Comment</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">DataType</span>&gt;</span>DINT<span class="tag">&lt;/<span class="name">DataType</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">Entry</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Entry</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Index</span> <span class="attr">DependOnSlot</span>=<span class="string">"true"</span>&gt;</span>#x606C<span class="tag">&lt;/<span class="name">Index</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">SubIndex</span>&gt;</span>0<span class="tag">&lt;/<span class="name">SubIndex</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">BitLen</span>&gt;</span>32<span class="tag">&lt;/<span class="name">BitLen</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Name</span> <span class="attr">LcId</span>=<span class="string">"1033"</span>&gt;</span>Actual Velocity<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Comment</span>&gt;</span>object 0x606C:0<span class="tag">&lt;/<span class="name">Comment</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">DataType</span>&gt;</span>DINT<span class="tag">&lt;/<span class="name">DataType</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">Entry</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Entry</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Index</span> <span class="attr">DependOnSlot</span>=<span class="string">"true"</span>&gt;</span>#x6077<span class="tag">&lt;/<span class="name">Index</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">SubIndex</span>&gt;</span>0<span class="tag">&lt;/<span class="name">SubIndex</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">BitLen</span>&gt;</span>16<span class="tag">&lt;/<span class="name">BitLen</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Name</span> <span class="attr">LcId</span>=<span class="string">"1033"</span>&gt;</span>Actual Torque<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Comment</span>&gt;</span>object 0x6077:0<span class="tag">&lt;/<span class="name">Comment</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">DataType</span>&gt;</span>INT<span class="tag">&lt;/<span class="name">DataType</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">Entry</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Entry</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Index</span> <span class="attr">DependOnSlot</span>=<span class="string">"true"</span>&gt;</span>#x6061<span class="tag">&lt;/<span class="name">Index</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">SubIndex</span>&gt;</span>0<span class="tag">&lt;/<span class="name">SubIndex</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">BitLen</span>&gt;</span>8<span class="tag">&lt;/<span class="name">BitLen</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Name</span> <span class="attr">LcId</span>=<span class="string">"1033"</span>&gt;</span>Mode Of OperationDisplay<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Comment</span>&gt;</span>object 0x6061:0<span class="tag">&lt;/<span class="name">Comment</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">DataType</span>&gt;</span>SINT<span class="tag">&lt;/<span class="name">DataType</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">Entry</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Entry</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Index</span> <span class="attr">DependOnSlot</span>=<span class="string">"true"</span>&gt;</span>#x603F<span class="tag">&lt;/<span class="name">Index</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">SubIndex</span>&gt;</span>0<span class="tag">&lt;/<span class="name">SubIndex</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">BitLen</span>&gt;</span>16<span class="tag">&lt;/<span class="name">BitLen</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Name</span> <span class="attr">LcId</span>=<span class="string">"1033"</span>&gt;</span>Error Code<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Comment</span>&gt;</span>object 0x603F:0<span class="tag">&lt;/<span class="name">Comment</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">DataType</span>&gt;</span>UINT<span class="tag">&lt;/<span class="name">DataType</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">Entry</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Entry</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">Index</span>&gt;</span>#x0<span class="tag">&lt;/<span class="name">Index</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">SubIndex</span>&gt;</span>0<span class="tag">&lt;/<span class="name">SubIndex</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">BitLen</span>&gt;</span>8<span class="tag">&lt;/<span class="name">BitLen</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">Entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">TxPdo</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>一步一步来</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Sm</span> <span class="attr">DefaultSize</span>=<span class="string">"20"</span> <span class="attr">StartAddress</span>=<span class="string">"#x1200"</span> <span class="attr">ControlByte</span>=<span class="string">"#x64"</span> <span class="attr">Enable</span>=<span class="string">"1"</span>&gt;</span>Outputs<span class="tag">&lt;/<span class="name">Sm</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Sm</span> <span class="attr">DefaultSize</span>=<span class="string">"14"</span> <span class="attr">StartAddress</span>=<span class="string">"#x1300"</span> <span class="attr">ControlByte</span>=<span class="string">"#x20"</span> <span class="attr">Enable</span>=<span class="string">"1"</span>&gt;</span>Inputs<span class="tag">&lt;/<span class="name">Sm</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这个单位是字节，所以是</p>
<p><code>RxPDO</code> 是 160bit</p>
<p><code>TxPDO</code> 是 112bit</p>
<p>第一步列出所需要的数据</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ec_pdo_entry_info_t</span> eyou_pdo_entries[] = {</span><br><span class="line">    <span class="comment">// RxPDO-1 (Total 160 bits / 20 bytes)</span></span><br><span class="line">    {<span class="number">0x6040</span>, <span class="number">0x00</span>, <span class="number">16</span>}, <span class="comment">// Control Word</span></span><br><span class="line">    {<span class="number">0x607A</span>, <span class="number">0x00</span>, <span class="number">32</span>}, <span class="comment">// Target Position</span></span><br><span class="line">    {<span class="number">0x60FF</span>, <span class="number">0x00</span>, <span class="number">32</span>}, <span class="comment">// Target Velocity</span></span><br><span class="line">    {<span class="number">0x6071</span>, <span class="number">0x00</span>, <span class="number">16</span>}, <span class="comment">// Target Torque</span></span><br><span class="line">    {<span class="number">0x6060</span>, <span class="number">0x00</span>, <span class="number">8</span>},  <span class="comment">// Modes of Operation</span></span><br><span class="line">    {<span class="number">0x0000</span>, <span class="number">0x00</span>, <span class="number">56</span>}, <span class="comment">// Padding</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// TxPDO-1 (Total 112 bits / 14 bytes)</span></span><br><span class="line">    {<span class="number">0x6041</span>, <span class="number">0x00</span>, <span class="number">16</span>}, <span class="comment">// Status Word</span></span><br><span class="line">    {<span class="number">0x6064</span>, <span class="number">0x00</span>, <span class="number">32</span>}, <span class="comment">// Position Actual Value</span></span><br><span class="line">    {<span class="number">0x606C</span>, <span class="number">0x00</span>, <span class="number">32</span>}, <span class="comment">// Velocity Actual Value</span></span><br><span class="line">    {<span class="number">0x6077</span>, <span class="number">0x00</span>, <span class="number">16</span>}, <span class="comment">// Torque Actual Value</span></span><br><span class="line">    {<span class="number">0x6061</span>, <span class="number">0x00</span>, <span class="number">8</span>},  <span class="comment">// Modes of Operation Display</span></span><br><span class="line">    {<span class="number">0x603F</span>, <span class="number">0x00</span>, <span class="number">8</span>}   <span class="comment">// Error Code (恢复为8-bit)</span></span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>唯一需要注意的是 </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="number">0x0000</span>, <span class="number">0x00</span>, <span class="number">56</span>}, <span class="comment">// Padding</span></span><br></pre></td></tr></table></figure>
<p>160 - 16 - 32 - 32 - 16 - 8 = 56.</p>
<p>剩下的其实是从 ESI 文件照搬下来的。</p>
<p>继续</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ec_pdo_info_t</span> eyou_pdos[] = {</span><br><span class="line">    {<span class="number">0x1600</span>, <span class="number">6</span>, eyou_pdo_entries + <span class="number">0</span>}, <span class="comment">// RxPDO</span></span><br><span class="line">    {<span class="number">0x1A00</span>, <span class="number">6</span>, eyou_pdo_entries + <span class="number">6</span>}  <span class="comment">// TxPDO</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ec_sync_info_t</span> eyou_syncs[] = {</span><br><span class="line">    {<span class="number">0</span>, EC_DIR_OUTPUT, <span class="number">0</span>, <span class="literal">NULL</span>, EC_WD_DISABLE},</span><br><span class="line">    {<span class="number">1</span>, EC_DIR_INPUT, <span class="number">0</span>, <span class="literal">NULL</span>, EC_WD_DISABLE},</span><br><span class="line">    {<span class="number">2</span>, EC_DIR_OUTPUT, <span class="number">1</span>, eyou_pdos + <span class="number">0</span>, EC_WD_ENABLE},</span><br><span class="line">    {<span class="number">3</span>, EC_DIR_INPUT, <span class="number">1</span>, eyou_pdos + <span class="number">1</span>, EC_WD_DISABLE},</span><br><span class="line">    {<span class="number">0xff</span>}</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现函数，返回静态的syncs数组</span></span><br><span class="line"><span class="function"><span class="type">ec_sync_info_t</span>* <span class="title">get_eyou_syncs</span><span class="params">(<span class="type">void</span>)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> eyou_syncs;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>这里是重新组织了一下</p>
<p>你可以理解为最后的结果类似于</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">eyouSyncs = [</span><br><span class="line">  { <span class="attr">index</span>: <span class="number">0</span>, <span class="attr">dir</span>: <span class="string">"output"</span>, <span class="attr">pdos</span>: [], <span class="attr">watchdog</span>: <span class="string">"disable"</span> },</span><br><span class="line">  { <span class="attr">index</span>: <span class="number">1</span>, <span class="attr">dir</span>: <span class="string">"input"</span>, <span class="attr">pdos</span>: [], <span class="attr">watchdog</span>: <span class="string">"disable"</span> },</span><br><span class="line">  { <span class="attr">index</span>: <span class="number">2</span>, <span class="attr">dir</span>: <span class="string">"output"</span>, <span class="attr">pdos</span>: [{ <span class="attr">index</span>: <span class="number">0x1600</span>, <span class="attr">entries</span>: eyouPdoEntries.<span class="title function_">slice</span>(<span class="number">0</span>, <span class="number">6</span>) }], <span class="attr">watchdog</span>: <span class="string">"enable"</span> },</span><br><span class="line">  { <span class="attr">index</span>: <span class="number">3</span>, <span class="attr">dir</span>: <span class="string">"input"</span>, <span class="attr">pdos</span>: [{ <span class="attr">index</span>: <span class="number">0x1A00</span>, <span class="attr">entries</span>: eyouPdoEntries.<span class="title function_">slice</span>(<span class="number">6</span>, <span class="number">12</span>) }], <span class="attr">watchdog</span>: <span class="string">"disable"</span> }</span><br><span class="line">];</span><br></pre></td></tr></table></figure>


<p>ok. 我有东西了，那就告诉从站，我会怎么传数据</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="built_in">LOG_INFO</span>(<span class="string">"MT电机 (从站 %zu) 配置PDO\n"</span>, i);</span><br><span class="line"> <span class="keyword">if</span> (<span class="built_in">ecrt_slave_config_pdos</span>(sc[i], EC_END, <span class="built_in">get_mt_syncs</span>()))</span><br><span class="line"> {</span><br><span class="line">	<span class="built_in">LOG_ERROR</span>(<span class="string">"MT电机 (从站 %zu) 配置PDO失败\n"</span>, i);</span><br><span class="line">	<span class="built_in">ecrt_release_master</span>(master);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>讲一个特殊的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (info[i].vendor_id == VENDOR_ID_TAISHAN &amp;&amp; info[i].product_code == PRODUCT_CODE_TAISHAN) {</span><br><span class="line">             <span class="built_in">LOG_INFO</span>(<span class="string">"TAISHAN电机 (从站 %zu) 配置PDO\n"</span>, i);</span><br><span class="line">             <span class="keyword">if</span> (<span class="built_in">ecrt_slave_config_pdos</span>(sc[i], EC_END, <span class="built_in">get_taishan_syncs</span>()))</span><br><span class="line">             {</span><br><span class="line">                <span class="built_in">LOG_ERROR</span>(<span class="string">"TAISHAN电机 (从站 %zu) 配置PDO失败\n"</span>, i);</span><br><span class="line">                <span class="built_in">ecrt_release_master</span>(master);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            }</span><br><span class="line">             <span class="comment">// 在 PREOP 通过 SDO 设定模式为 CSP</span></span><br><span class="line">             <span class="keyword">if</span> (<span class="built_in">ecrt_slave_config_sdo8</span>(sc[i], <span class="number">0x6060</span>, <span class="number">0x00</span>, OP_MODE_CSP)) {</span><br><span class="line">                 <span class="built_in">LOG_ERROR</span>(<span class="string">"TAISHAN电机 (从站 %zu) 设置SDO 0x6060 失败\n"</span>, i);</span><br><span class="line">             }</span><br><span class="line">        }</span><br></pre></td></tr></table></figure>
<p>ecrt_slave_config_sdo8 这个就是没有InitCmd的后果.</p>
<h3 id="DC设置"><a href="#DC设置" class="headerlink" title="DC设置"></a>DC设置</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//配置分布式时钟 (DC)</span></span><br><span class="line"><span class="built_in">LOG_INFO</span>(<span class="string">"配置分布式时钟 (DC)...\n"</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; num_slaves; i++)</span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">ecrt_slave_config_dc</span>(sc[i], <span class="number">0x0300</span>, CYCLE_TIME_NS, <span class="number">2</span> * CYCLE_TIME_NS / <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>) != <span class="number">0</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">"从站 %zu 配置分布式时钟失败\n"</span>, i);</span><br><span class="line">        <span class="built_in">ecrt_release_master</span>(master);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="built_in">LOG_INFO</span>(<span class="string">"配置分布式时钟成功\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// **新增：选择此从站作为总线的参考时钟**</span></span><br><span class="line"><span class="built_in">LOG_INFO</span>(<span class="string">"选择参考时钟...\n"</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">ecrt_master_select_reference_clock</span>(master, sc[<span class="number">0</span>]))</span><br><span class="line">{</span><br><span class="line">    <span class="built_in">LOG_ERROR</span>(<span class="string">"选择参考时钟失败\n"</span>);</span><br><span class="line">    <span class="built_in">ecrt_release_master</span>(master);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">{</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">"选择参考时钟成功\n"</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">OpMode</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Name</span>&gt;</span>DC<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Desc</span>&gt;</span>DC-Synchron<span class="tag">&lt;/<span class="name">Desc</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">AssignActivate</span>&gt;</span>#x300<span class="tag">&lt;/<span class="name">AssignActivate</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">CycleTimeSync0</span> <span class="attr">Factor</span>=<span class="string">"1"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">CycleTimeSync0</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">ShiftTimeSync0</span>&gt;</span>0<span class="tag">&lt;/<span class="name">ShiftTimeSync0</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">CycleTimeSync1</span> <span class="attr">Factor</span>=<span class="string">"1"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">CycleTimeSync1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">OpMode</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里讲一下参数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ecrt_slave_config_dc</span>(sc[i], <span class="number">0x0300</span>, CYCLE_TIME_NS, <span class="number">2</span> * CYCLE_TIME_NS / <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"><span class="built_in">ecrt_slave_config_dc</span>(从站配置对象, ESI文件AssignActivate, SYNC0 的周期(我设置的是一毫秒</span><br><span class="line">), SYNC0 的相位偏移，相对于周期起点的时间偏移（可为负, SYNC1 的周期, SYNC1 的相位偏移)</span><br></pre></td></tr></table></figure>
<p>这里其实是我的知识盲点</p>
<blockquote>
<p>SYNC0 的相位偏移，相对于周期起点的时间偏移（可为负</p>
</blockquote>
<figure class="highlight plaintext"><figcaption><span>Text</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">时间 →</span><br><span class="line">0                 t_send            φ0(SYNC0)                  T</span><br><span class="line">|------------------|------------------|-------------------------|</span><br><span class="line">  收包→计算→发包          前余量 M_pre=φ0−t_send        后空档 M_post=T−φ0</span><br><span class="line">说明：</span><br><span class="line">- 相位偏移 φ0：本周期内 SYNC0 发生的时刻（由 sync0_shift 决定）。</span><br><span class="line">- 前余量 M_pre：你完成发送到 SYNC0 到来之间的空档。只要 M_pre &gt; 0（且留安全裕量），</span><br><span class="line">  本圈输出会在本圈的 SYNC0 被从站锁存/应用。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">时间 →</span><br><span class="line">0                             φ0(SYNC0)         t_send             T</span><br><span class="line">|------------------------------|------------------|-----------------|</span><br><span class="line">  收包→计算→发包耗时过长          （本圈已错过）         发送完成太晚→晚一圈生效</span><br><span class="line"></span><br><span class="line">下一周期（k+1）：</span><br><span class="line">T                      T+φ0(SYNC0)</span><br><span class="line">|----------------------|</span><br><span class="line">此时才在下一圈的 SYNC0 锁存/应用上一圈发出的输出</span><br></pre></td></tr></table></figure>


<h3 id="ecrt-domain-reg-pdo-entry-list"><a href="#ecrt-domain-reg-pdo-entry-list" class="headerlink" title="ecrt_domain_reg_pdo_entry_list"></a>ecrt_domain_reg_pdo_entry_list</h3><p>之前的</p>
<ul>
<li>ecrt_slave_config_pdos：配置“从站硬件发什么/收什么”（线上布局）。</li>
<li>ecrt_domain_reg_pdo_entry_list：配置“主站本地怎么访问它们”（内存偏移）。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EYOU电机PDO注册</span></span><br><span class="line">domain_regs[reg_idx++] = (<span class="type">ec_pdo_entry_reg_t</span>){info[i].alias, info[i].position, VENDOR_ID_EYOU, PRODUCT_CODE_EYOU, <span class="number">0x6040</span>, <span class="number">0</span>, &amp;off_control_word[i]};</span><br><span class="line">domain_regs[reg_idx++] = (<span class="type">ec_pdo_entry_reg_t</span>){info[i].alias, info[i].position, VENDOR_ID_EYOU, PRODUCT_CODE_EYOU, <span class="number">0x607A</span>, <span class="number">0</span>, &amp;off_target_position[i]};</span><br><span class="line">domain_regs[reg_idx++] = (<span class="type">ec_pdo_entry_reg_t</span>){info[i].alias, info[i].position, VENDOR_ID_EYOU, PRODUCT_CODE_EYOU, <span class="number">0x60FF</span>, <span class="number">0</span>, &amp;off_target_velocity[i]};</span><br><span class="line">domain_regs[reg_idx++] = (<span class="type">ec_pdo_entry_reg_t</span>){info[i].alias, info[i].position, VENDOR_ID_EYOU, PRODUCT_CODE_EYOU, <span class="number">0x6071</span>, <span class="number">0</span>, &amp;off_target_torque[i]};</span><br><span class="line">domain_regs[reg_idx++] = (<span class="type">ec_pdo_entry_reg_t</span>){info[i].alias, info[i].position, VENDOR_ID_EYOU, PRODUCT_CODE_EYOU, <span class="number">0x6060</span>, <span class="number">0</span>, &amp;off_modes_of_operation[i]};</span><br><span class="line">domain_regs[reg_idx++] = (<span class="type">ec_pdo_entry_reg_t</span>){info[i].alias, info[i].position, VENDOR_ID_EYOU, PRODUCT_CODE_EYOU, <span class="number">0x6041</span>, <span class="number">0</span>, &amp;off_status_word[i]};</span><br><span class="line">domain_regs[reg_idx++] = (<span class="type">ec_pdo_entry_reg_t</span>){info[i].alias, info[i].position, VENDOR_ID_EYOU, PRODUCT_CODE_EYOU, <span class="number">0x6064</span>, <span class="number">0</span>, &amp;off_position_actual_value[i]};</span><br><span class="line">domain_regs[reg_idx++] = (<span class="type">ec_pdo_entry_reg_t</span>){info[i].alias, info[i].position, VENDOR_ID_EYOU, PRODUCT_CODE_EYOU, <span class="number">0x606C</span>, <span class="number">0</span>, &amp;off_velocity_actual_value[i]};</span><br><span class="line">domain_regs[reg_idx++] = (<span class="type">ec_pdo_entry_reg_t</span>){info[i].alias, info[i].position, VENDOR_ID_EYOU, PRODUCT_CODE_EYOU, <span class="number">0x6077</span>, <span class="number">0</span>, &amp;off_torque_actual_value[i]};</span><br><span class="line">domain_regs[reg_idx++] = (<span class="type">ec_pdo_entry_reg_t</span>){info[i].alias, info[i].position, VENDOR_ID_EYOU, PRODUCT_CODE_EYOU, <span class="number">0x6061</span>, <span class="number">0</span>, &amp;off_modes_of_operation_display[i]};</span><br><span class="line">domain_regs[reg_idx++] = (<span class="type">ec_pdo_entry_reg_t</span>){info[i].alias, info[i].position, VENDOR_ID_EYOU, PRODUCT_CODE_EYOU, <span class="number">0x603F</span>, <span class="number">0</span>, &amp;off_error_code[i]};</span><br></pre></td></tr></table></figure>
<p>其实就是按照</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">static ec_pdo_entry_info_t eyou_pdo_entries[] = {</span><br><span class="line">    // RxPDO-1 (Total 160 bits / 20 bytes)</span><br><span class="line">    {0x6040, 0x00, 16}, // Control Word</span><br><span class="line">    {0x607A, 0x00, 32}, // Target Position</span><br><span class="line">    {0x60FF, 0x00, 32}, // Target Velocity</span><br><span class="line">    {0x6071, 0x00, 16}, // Target Torque</span><br><span class="line">    {0x6060, 0x00, 8},  // Modes of Operation</span><br><span class="line">    {0x0000, 0x00, 56}, // Padding</span><br><span class="line"></span><br><span class="line">    // TxPDO-1 (Total 112 bits / 14 bytes)</span><br><span class="line">    {0x6041, 0x00, 16}, // Status Word</span><br><span class="line">    {0x6064, 0x00, 32}, // Position Actual Value</span><br><span class="line">    {0x606C, 0x00, 32}, // Velocity Actual Value</span><br><span class="line">    {0x6077, 0x00, 16}, // Torque Actual Value</span><br><span class="line">    {0x6061, 0x00, 8},  // Modes of Operation Display</span><br><span class="line">    {0x603F, 0x00, 8}   // Error Code (恢复为8-bit)</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>去注册.</p>
<p>需要注册的是 &amp;off_error_code[i], 基本都是偏移的值，后续循环的时候需要使用。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ecrt_domain_reg_pdo_entry_list</span>(domain, domain_regs)</span><br></pre></td></tr></table></figure>
<p>最后给主站注册这些地址.</p>
<h3 id="一些核心配置"><a href="#一些核心配置" class="headerlink" title="一些核心配置"></a>一些核心配置</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置实时调度策略</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">sched_param</span> param = {};</span><br><span class="line">param.sched_priority = <span class="built_in">sched_get_priority_max</span>(SCHED_FIFO);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">sched_setscheduler</span>(<span class="number">0</span>, SCHED_FIFO, &amp;param) == <span class="number">-1</span>) {</span><br><span class="line">    <span class="built_in">perror</span>(<span class="string">"error: sched_setscheduler failed"</span>);</span><br><span class="line">    <span class="comment">// Don't exit. This can fail if the user is not root.</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// **新增：锁定内存，防止分页（swapping）导致的延迟**</span></span><br><span class="line"><span class="built_in">LOG_INFO</span>(<span class="string">"锁定内存...\n"</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">mlockall</span>(MCL_CURRENT | MCL_FUTURE) == <span class="number">-1</span>) {</span><br><span class="line">    <span class="built_in">perror</span>(<span class="string">"error: mlockall failed"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// **新增：将进程绑定到单个CPU核心以提高实时确定性**</span></span><br><span class="line"><span class="type">int</span> core_to_bind = <span class="number">3</span>; <span class="comment">// 默认核心</span></span><br><span class="line"><span class="keyword">if</span> (argc &gt; <span class="number">4</span>) {</span><br><span class="line">    <span class="type">char</span>* endptr;</span><br><span class="line">    <span class="type">long</span> core_long = <span class="built_in">strtol</span>(argv[<span class="number">4</span>], &amp;endptr, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> (endptr == argv[<span class="number">4</span>] || *endptr != <span class="string">'\0'</span> || core_long &lt; <span class="number">0</span>) {</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(<span class="string">"无效的CPU核心号 '%s'。将使用默认核心 %d。\n"</span>, argv[<span class="number">4</span>], core_to_bind);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        core_to_bind = (<span class="type">int</span>)core_long;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="built_in">LOG_INFO</span>(<span class="string">"将进程绑定到CPU核心%d...\n"</span>, core_to_bind);</span><br><span class="line"><span class="type">cpu_set_t</span> cpuset;</span><br><span class="line"><span class="built_in">CPU_ZERO</span>(&amp;cpuset);</span><br><span class="line"><span class="built_in">CPU_SET</span>(core_to_bind, &amp;cpuset); <span class="comment">// 使用变量</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">sched_setaffinity</span>(<span class="number">0</span>, <span class="built_in">sizeof</span>(<span class="type">cpu_set_t</span>), &amp;cpuset) == <span class="number">-1</span>) {</span><br><span class="line">    <span class="built_in">perror</span>(<span class="string">"error: sched_setaffinity failed"</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>这些其实主要是为了提高系统的实时性。</p>
<p>按需取用即可，甚至你可以不用。</p>
<h3 id="激活主站"><a href="#激活主站" class="headerlink" title="激活主站"></a>激活主站</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">crt_master_activate</span>(master)</span><br></pre></td></tr></table></figure>


<h3 id="过程数据指针"><a href="#过程数据指针" class="headerlink" title="过程数据指针"></a>过程数据指针</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint8_t</span> *domain_pd = <span class="built_in">ecrt_domain_data</span>(domain)</span><br></pre></td></tr></table></figure>
<p>用<code>domain_pd</code> + 之前注册得到的偏移 off_，在实时循环里直接读/写 PDO 条目。</p>
<h3 id="开始循环"><a href="#开始循环" class="headerlink" title="开始循环"></a>开始循环</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">LOG_INFO</span>(<span class="string">"设置初始应用时间...\n"</span>);</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">timespec</span> wakeupTime;</span><br><span class="line"><span class="built_in">clock_gettime</span>(CLOCK_MONOTONIC, &amp;wakeupTime);</span><br></pre></td></tr></table></figure>
<p>初始化时间</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> cycle_counter = <span class="number">0</span>;</span><br><span class="line"><span class="type">int32_t</span> initial_position[num_slaves];</span><br><span class="line"><span class="type">int</span> initialized[num_slaves];</span><br><span class="line"><span class="type">uint64_t</span> start_motion_cycle[num_slaves];</span><br><span class="line"><span class="comment">// 为每个从站创建独立的当前速度变量</span></span><br><span class="line"><span class="type">double</span> current_velocity[num_slaves];</span><br><span class="line"><span class="comment">// 新增: 仅写一次操作模式</span></span><br><span class="line"><span class="type">int</span> op_mode_written[num_slaves];</span><br><span class="line"><span class="comment">// VLAs cannot be initialized with {}, so we use memset.</span></span><br><span class="line"><span class="built_in">memset</span>(initialized, <span class="number">0</span>, <span class="built_in">sizeof</span>(initialized));</span><br><span class="line"><span class="built_in">memset</span>(start_motion_cycle, <span class="number">0</span>, <span class="built_in">sizeof</span>(start_motion_cycle));</span><br><span class="line"><span class="built_in">memset</span>(current_velocity, <span class="number">0</span>, <span class="built_in">sizeof</span>(current_velocity));</span><br><span class="line"><span class="built_in">memset</span>(op_mode_written, <span class="number">0</span>, <span class="built_in">sizeof</span>(op_mode_written));</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">timespec</span> before_sleep;</span><br><span class="line"><span class="type">long</span> sleep_duration_us;</span><br><span class="line"><span class="comment">// 新增: 用于测量网络往返时间 (RTT)</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">timespec</span> last_send_time_rtt;</span><br><span class="line"><span class="type">long</span> rtt_us;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>初始化参数</p>
<blockquote>
<ul>
<li>EC_WC_ZERO：本周期“未交换任何已注册的过程数据”。常见原因：域未激活/未queue+send、PDO 注册或映射不匹配、链路/从站掉线。</li>
<li>EC_WC_INCOMPLETE：本周期“只交换了部分过程数据”。常见原因：丢帧、个别从站未响应、周期超时/系统过载、拓扑或电缆问题。</li>
<li>EC_WC_COMPLETE：本周期“已交换全部注册的过程数据”。理想状态。</li>
</ul>
</blockquote>
<p>开始循环</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (keep_runing)</span><br><span class="line">{</span><br><span class="line">	<span class="comment">//加一毫秒</span></span><br><span class="line">	wakeupTime.tv_nsec += CYCLE_TIME_NS;</span><br><span class="line">	<span class="keyword">while</span> (wakeupTime.tv_nsec &gt;= <span class="number">1000000000</span>) {</span><br><span class="line">		wakeupTime.tv_nsec -= <span class="number">1000000000</span>;</span><br><span class="line">		wakeupTime.tv_sec++;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">//设置 before_sleep</span></span><br><span class="line">    <span class="built_in">clock_gettime</span>(CLOCK_MONOTONIC, &amp;before_sleep);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//让当前线程睡眠到wakeupTime 时间</span></span><br><span class="line">	<span class="built_in">clock_nanosleep</span>(CLOCK_MONOTONIC, TIMER_ABSTIME, &amp;wakeupTime, <span class="literal">NULL</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//计算出计划睡多久</span></span><br><span class="line">	<span class="comment">//sleep_duration_us = (wakeupTime.tv_sec - before_sleep.tv_sec) * 1000000 + (wakeupTime.tv_nsec - before_sleep.tv_nsec) / 1000;</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//设置这个周期开始时间</span></span><br><span class="line">	<span class="built_in">ecrt_master_application_time</span>(master, wakeupTime.tv_sec * <span class="number">1000000000LL</span> + wakeupTime.tv_nsec);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">ecrt_master_receive</span>(master);</span><br><span class="line">    <span class="built_in">ecrt_domain_process</span>(domain);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//查看域的状态.</span></span><br><span class="line">	<span class="type">ec_domain_state_t</span> domain_state;</span><br><span class="line">    <span class="built_in">ecrt_domain_state</span>(domain, &amp;domain_state);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//可以简单理解为 EC_WC_COMPLETE 是最理想的状态</span></span><br><span class="line">	<span class="keyword">if</span> (domain_state.wc_state == EC_WC_COMPLETE) {</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; num_slaves; i++)</span><br><span class="line">        {</span><br><span class="line">			<span class="type">uint16_t</span> status_word;</span><br><span class="line">			<span class="type">int32_t</span> pos_val;</span><br><span class="line">			<span class="type">int32_t</span> vel_val;</span><br><span class="line">			<span class="type">int16_t</span> tor_val;</span><br><span class="line">			<span class="type">uint8_t</span> op_mode_display;</span><br><span class="line">			</span><br><span class="line">			status_word = <span class="built_in">EC_READ_U16</span>(domain_pd + off_status_word[i]);</span><br><span class="line">			pos_val = <span class="built_in">EC_READ_S32</span>(domain_pd + off_position_actual_value[i]);</span><br><span class="line">			vel_val = <span class="built_in">EC_READ_S32</span>(domain_pd + off_velocity_actual_value[i]);</span><br><span class="line">			tor_val = <span class="built_in">EC_READ_S16</span>(domain_pd + off_torque_actual_value[i]);</span><br><span class="line">			op_mode_display = <span class="built_in">EC_READ_U8</span>(domain_pd + off_modes_of_operation_display[i]);</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//先处理各种状态,初始化等等</span></span><br><span class="line">			<span class="comment">//https://doc-legacy.synapticon.com/software/44/documentation_html/object_htmls/6041/index.html</span></span><br><span class="line">			<span class="comment">//表示8,也就是 1000，表示有错误</span></span><br><span class="line">			<span class="type">uint16_t</span> control_word = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> ((status_word &amp; <span class="number">0x0008</span>) == <span class="number">0x0008</span>)</span><br><span class="line">            { </span><br><span class="line">				<span class="comment">// Fault	//https://doc-legacy.synapticon.com/software/44/documentation_html/object_htmls/6040/index.html</span></span><br><span class="line">				<span class="comment">//第七位设置成1.</span></span><br><span class="line">                control_word = <span class="number">0x0080</span>; <span class="comment">// Fault reset</span></span><br><span class="line">            }</span><br><span class="line">			<span class="comment">//判断是否使能</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> ((status_word &amp; <span class="number">0x006F</span>) == <span class="number">0x0027</span>)</span><br><span class="line">            {   </span><br><span class="line">                <span class="comment">// Operation enabled</span></span><br><span class="line">                <span class="comment">// --- 修复: 如果错过了 "Switched on" 状态，在此处进行初始化 ---</span></span><br><span class="line">                <span class="keyword">if</span> (!initialized[i])</span><br><span class="line">                {</span><br><span class="line">                    initial_position[i] = pos_val; <span class="comment">//初始化未知</span></span><br><span class="line">                    initialized[i] = <span class="number">1</span>; <span class="comment">//从站初始化,具体哪个从站</span></span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (start_motion_cycle[i] == <span class="number">0</span>)</span><br><span class="line">                { <span class="comment">// 仅记录一次运动开始时间</span></span><br><span class="line">                    start_motion_cycle[i] = cycle_counter;</span><br><span class="line">                }</span><br><span class="line">				<span class="comment">//维持使能状态</span></span><br><span class="line">                control_word = <span class="number">0x000F</span>; <span class="comment">// Keep enabled</span></span><br><span class="line">            }</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> ((status_word &amp; <span class="number">0x006F</span>) == <span class="number">0x0023</span>)</span><br><span class="line">            { </span><br><span class="line">                <span class="comment">// Switched on</span></span><br><span class="line">                <span class="keyword">if</span> (!initialized[i])</span><br><span class="line">                {</span><br><span class="line">                    initial_position[i] = pos_val;</span><br><span class="line">                    initialized[i] = <span class="number">1</span>;</span><br><span class="line">                    <span class="built_in">LOG_INFO</span>(<span class="string">"周期 %u - 从站 %zu 已锁定初始位置: %d\n"</span>, cycle_counter, i, initial_position[i]);</span><br><span class="line">                    <span class="built_in">fflush</span>(stdout);</span><br><span class="line">                }</span><br><span class="line">                control_word = <span class="number">0x000F</span>; <span class="comment">// Enable operation</span></span><br><span class="line">            }</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> ((status_word &amp; <span class="number">0x006F</span>) == <span class="number">0x0021</span>)</span><br><span class="line">            { </span><br><span class="line">                <span class="comment">// Ready to switch on</span></span><br><span class="line">                control_word = <span class="number">0x0007</span>; <span class="comment">// Switch on</span></span><br><span class="line">            }</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> ((status_word &amp; <span class="number">0x004F</span>) == <span class="number">0x0040</span>)</span><br><span class="line">            { </span><br><span class="line">                <span class="comment">// Switch on disabled</span></span><br><span class="line">                control_word = <span class="number">0x0006</span>; <span class="comment">// Shutdown</span></span><br><span class="line">            }</span><br><span class="line">			</span><br><span class="line">			<span class="type">int32_t</span> target_pos = <span class="number">0</span>;</span><br><span class="line">            <span class="type">int32_t</span> target_vel = <span class="number">0</span>;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//如果前面初始化了</span></span><br><span class="line">			<span class="keyword">if</span> (initialized[i])</span><br><span class="line">            {</span><br><span class="line">				<span class="comment">// 根据所选模式计算目标值</span></span><br><span class="line">                <span class="keyword">switch</span> (selected_mode) {</span><br><span class="line">                    <span class="keyword">case</span> MODE_CSP:</span><br><span class="line">                        target_pos = <span class="built_in">csp_run</span>(</span><br><span class="line">                            cycle_counter,</span><br><span class="line">                            start_motion_cycle[i],</span><br><span class="line">                            initial_position[i],</span><br><span class="line">                            csp_params_ptr, <span class="comment">// 传递指针</span></span><br><span class="line">                            CYCLE_TIME_NS</span><br><span class="line">                        );</span><br><span class="line">						</span><br><span class="line">						<span class="comment">// 这个是通过传入的基础速度并且根据圈数然后返回一个最新的位置，从而达到一直旋转的地步</span></span><br><span class="line">						<span class="comment">// int32_t csp_run(</span></span><br><span class="line">						<span class="comment">//     uint64_t cycle_counter, </span></span><br><span class="line">						<span class="comment">//     uint64_t start_motion_cycle,</span></span><br><span class="line">						<span class="comment">//     int32_t initial_position,</span></span><br><span class="line">						<span class="comment">//     const Csp_Params_t *params, // 接收参数指针</span></span><br><span class="line">						<span class="comment">//     double cycle_time_ns</span></span><br><span class="line">						<span class="comment">// ) {</span></span><br><span class="line">						<span class="comment">//     int32_t target_pos = initial_position; // 默认为初始位置</span></span><br><span class="line">						<span class="comment">//     const Csp_Params_t *p = (params == NULL) ? &amp;default_csp_params : params;</span></span><br><span class="line"></span><br><span class="line">						<span class="comment">//     if (start_motion_cycle &gt; 0)</span></span><br><span class="line">						<span class="comment">//     { // 电机已使能并准备好运动</span></span><br><span class="line">						<span class="comment">//         // --- 恒速运动控制 ---</span></span><br><span class="line">						<span class="comment">//         double elapsed_time_s = (cycle_counter - start_motion_cycle) * (cycle_time_ns / 1e9);</span></span><br><span class="line">						<span class="comment">//         target_pos = initial_position + (int32_t)(p-&gt;velocity * elapsed_time_s);</span></span><br><span class="line">						<span class="comment">//     }</span></span><br><span class="line">							</span><br><span class="line">						<span class="comment">//     return target_pos;</span></span><br><span class="line">						<span class="comment">// }</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> MODE_CSV:</span><br><span class="line">						<span class="comment">//csv_run 同理，返回一个速度</span></span><br><span class="line">                        target_vel = <span class="built_in">csv_run</span>(csv_params_ptr, &amp;current_velocity[i], CYCLE_TIME_NS);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> NUM_MODES: <span class="comment">// 处理枚举警告</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">			}</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//这个PDO再设置一次模式.</span></span><br><span class="line">			<span class="comment">//确保进入 OP 后模式确实生效。部分驱动在 PREOP/SAFEOP 用 SDO写的模式，切到 OP 或复位后可能被覆盖/忽略。</span></span><br><span class="line">			<span class="comment">//覆盖厂家 ESI 里的默认/InitCmd（有的 ESI会把 0x6060 设为 0x08 等），用 PDO 在OP里再写一次更稳。</span></span><br><span class="line">			<span class="comment">//实时安全：SDO 属于邮箱通信，慢且不适合实时环；PDO 写一次即可（用 op_mode_written[i] 防止每周期反复写导致状态抖动）。</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!op_mode_written[i]) {</span><br><span class="line">				<span class="comment">// TAISHAN 无 0x6060 PDO，避免写入</span></span><br><span class="line">				<span class="keyword">if</span> (!(info[i].vendor_id == VENDOR_ID_TAISHAN &amp;&amp; info[i].product_code == PRODUCT_CODE_TAISHAN)) {</span><br><span class="line">					<span class="built_in">EC_WRITE_S8</span>(domain_pd + off_modes_of_operation[i], op_mode_code);</span><br><span class="line">				}</span><br><span class="line">				op_mode_written[i] = <span class="number">1</span>;</span><br><span class="line">			}</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//写入控制字</span></span><br><span class="line">			<span class="comment">//每次都写入。</span></span><br><span class="line">			<span class="built_in">EC_WRITE_U16</span>(domain_pd + off_control_word[i], control_word);</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// 根据模式写入不同的目标值</span></span><br><span class="line">			<span class="keyword">switch</span> (selected_mode) {</span><br><span class="line">				<span class="keyword">case</span> MODE_CSP:</span><br><span class="line">				</span><br><span class="line">					<span class="comment">//这个很简单写入位置信息到域里面</span></span><br><span class="line">					<span class="built_in">EC_WRITE_S32</span>(domain_pd + off_target_position[i], target_pos);</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> MODE_CSV:</span><br><span class="line">				</span><br><span class="line">					<span class="comment">// TAISHAN 无 0x60FF/0x6071，跳过CSV写入</span></span><br><span class="line">					<span class="comment">//这个是</span></span><br><span class="line">					<span class="keyword">if</span> (!(info[i].vendor_id == VENDOR_ID_TAISHAN &amp;&amp; info[i].product_code == PRODUCT_CODE_TAISHAN)) {</span><br><span class="line">						<span class="comment">//写入速度</span></span><br><span class="line">						<span class="built_in">EC_WRITE_S32</span>(domain_pd + off_target_velocity[i], target_vel);</span><br><span class="line">						<span class="comment">//这个扭矩这个我其实不太清楚。</span></span><br><span class="line">						<span class="comment">//为什么需要增加扭矩?</span></span><br><span class="line">						<span class="comment">//可能是因为有些ESI文件有要求。</span></span><br><span class="line">						<span class="keyword">if</span> (!(info[i].vendor_id == VENDOR_ID_JXZN &amp;&amp; info[i].product_code == PRODUCT_CODE_JXZN)) {</span><br><span class="line">							<span class="built_in">EC_WRITE_S16</span>(domain_pd + off_target_torque[i], <span class="number">500</span>);</span><br><span class="line">						} <span class="keyword">else</span> {</span><br><span class="line">							<span class="built_in">EC_WRITE_S16</span>(domain_pd + off_target_torque[i], <span class="number">0</span>);</span><br><span class="line">						}</span><br><span class="line">					}</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> NUM_MODES: <span class="comment">// 处理枚举警告</span></span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			}</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//这个是因为其他ok，但是MT必须要一个这个，他是必填的</span></span><br><span class="line">			<span class="comment">//所以单独发一下他</span></span><br><span class="line">			<span class="keyword">if</span> (info[i].vendor_id == VENDOR_ID_MT &amp;&amp; info[i].product_code == PRODUCT_CODE_MT) {</span><br><span class="line">				<span class="built_in">EC_WRITE_U16</span>(domain_pd + off_max_torque[i], <span class="number">1000</span>); <span class="comment">// 示例值: 设置一个最大转矩</span></span><br><span class="line">			}</span><br><span class="line">			</span><br><span class="line">            <span class="comment">// 保存当前发送时间作为下一个周期的上一次发送时间</span></span><br><span class="line">            last_send_time = send_time;</span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 新增：同步参考时钟。这是让DC同步正常工作的最关键一步。</span></span><br><span class="line">        <span class="comment">// 它会读取参考从站的时钟，并调整主站的逻辑时钟以消除漂移。</span></span><br><span class="line">        <span class="built_in">ecrt_master_sync_reference_clock</span>(master);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 原有的从站时钟同步，现在跟在参考时钟同步之后，以确保正确的同步顺序。</span></span><br><span class="line">        <span class="built_in">ecrt_master_sync_slave_clocks</span>(master);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将更新后的数据帧放入队列并发送</span></span><br><span class="line">        <span class="built_in">ecrt_domain_queue</span>(domain);</span><br><span class="line">        <span class="built_in">ecrt_master_send</span>(master);</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">clock_gettime</span>(CLOCK_MONOTONIC, &amp;last_send_time_rtt);</span><br><span class="line"></span><br><span class="line">        cycle_counter++;</span><br><span class="line"></span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>然后电机就可以成功运行起来了。</p>
<p>其他模式或者你想怎么更细节的电机控制，比如精细的控制，控制到哪一步。</p>
<p>就看你具体的模式了</p>
</div>
    </div>

    <div class="post-meta">
        <i>
        
            <span>2025-10-20</span>
            
                <span>该篇文章被 tommy</span>
            
            
                <span>打上标签:
                    
                    
                        <a href='/tags/ethercat/'>
                            ethercat
                        </a>
                    
                        <a href='/tags/CIA402/'>
                            CIA402
                        </a>
                    
                        <a href='/tags/robot/'>
                            robot
                        </a>
                    
                </span>
             
             
        
        </i>
    </div>
    <br>
    
    
        
            
    
            <div class="post-footer-pre-next">
                
                    <span>上一篇：<a href='/2025/10/20/202510/typescript%20%E7%B4%A2%E5%BC%95%E7%AD%BE%E5%90%8D/'></a></span>
                

                
                    <span class="post-footer-pre-next-last-span-right">下一篇：<a href="/2025/10/16/202510/typescript%20record/">什么是MIT协议?</a>
                    </span>
                
            </div>
    
        
    

    
        
    <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
         
    </div>
    
        

    <div id="waline"></div>
    <script type="module"  >
        import { init } from 'https://npm.elemecdn.com/hexo-theme-a4@latest/source/js/waline.mjs'; 
        function loadWaline() {
            init({
                el: '#waline',
                serverURL: 'walineserver-phi.vercel.app',
                lang: 'zh-CN',
                dark: 'body[class~="dark-mode"]',
                requiredMeta: ['nick','mail'], // cannot customize by theme config, change it yourself
                search: false, // 禁止表情包搜索
                reaction: false, // 对文章打分
                pageview: false, // 浏览量统计
                comment: false, // 评论数统计

                locale: {
                    placeholder: '留下你的评论吧。', 
                    sofa: ''
                },
            });
            
        }
        window.addEventListener('DOMContentLoaded', loadWaline);
    </script>



    
    
    
    </div>


     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
            © 1949-2023 China 

            
                

            
        </span>
       
    
</div>



<!--这是指一条线往下的内容-->
<div class="footer-last">
    
            <span>神仙树暴龙战士</span>
            
                <span class="footer-last-span-right"><i>本站由<a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/index.html">Hexo</a>驱动｜使用<a target="_blank" rel="noopener" href="https://github.com/HiNinoJay/hexo-theme-A4">Hexo-theme-A4</a>主题</i></span>
            
    
</div>


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <!--目录-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    

    
<script src="/js/randomHeaderContent.js"></script>

    <!--回到顶部按钮-->
    
        
<script src="/js/returnToTop.js"></script>

    

    
        
<script src="/js/returnToLastPage.js"></script>

    





<script src="/js/lightgallery/lightgallery.umd.min.js"></script>



<script src="/js/lightgallery/plugins/lg-thumbnail.umd.min.js"></script>



<script src="/js/lightgallery/plugins/lg-fullscreen.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-autoplay.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-zoom.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-rotate.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-paper.umd.min.js"></script>




<script type="text/javascript">
     
    if (typeof lightGallery !== "undefined") {
        var options1 = {
            selector: '.gallery-item',
            plugins: [lgThumbnail, lgFullscreen, lgAutoplay, lgZoom, lgRotate, lgPager], // 启用插件
            thumbnail: true,          // 显示缩略图
            zoom: true,               // 启用缩放功
            rotate: true,             // 启用旋转功能能
            autoplay: true,        // 启用自动播放功能
            fullScreen: true,      // 启用全屏功能
            pager: false, //页码,
            zoomFromOrigin: true,   // 从原始位置缩放
            actualSize: true,       // 启用查看实际大小的功能
            enableZoomAfter: 300,    // 延迟缩放，确保图片加载完成后可缩放
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options1); // 修复选择器
    }
    
</script>


    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> 

                </div>
            
            
                <!-- 回到顶部的按钮-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
            
                <!-- 返回的按钮-->  
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>
</html>