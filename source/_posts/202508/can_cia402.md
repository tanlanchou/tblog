# Can & CIA402

这篇文章是为了梳理整个 **Can** 电机和 **Cia402** 的流程





### 整体流程备份

我来给你一条“从上电到闭环”的完整文字流程，涵盖要配什么、怎么使能、是否需要 PDO、以及怎么收反馈。默认场景：Classic CANopen + CiA 402，节点号为 N（1..127）。

### 整体流程（推荐做法）

- **0) 上电与总线就绪**
  
  - 确认波特率一致、两端120 Ω终端正确、所有节点共地。
  - 可先下发 NMT “进入预运行态（Pre‑op）”：`COB=0x000`, Data=`80 N`。

- **1) 配置（SDO，常见且必要）**
  
  - **设备工作模式**：`0x6060` 写入模式（PP=1、PV=3、PT=4、Homing=6、CSP=8、CSV=9、CST=10）。  
  - **运动学参数（按模式选）**：
    - PP：`0x607A 目标位置`（单位/缩放按厂商EDS）、`0x6081 轮廓速度`、`0x6083/0x6084 加/减速度`。
    - PV：`0x60FF 目标速度`、`0x6083/0x6084`。
    - CST/CSV/CSP：周期量由 PDO 周期写入，仍可设限速/加减速度上限等。
  - **系统管理/心跳（建议）**：`0x1017 Producer Heartbeat Time`（例如 1000 ms），必要时配置 `0x1016 Consumer`。
  - （可选）**PDO 映射与通信参数**（见第3步说明；为了实时性通常需要）

- **2) 切到运行态并“使能驱动”**
  
  - 切 Operational：NMT Start Remote Node：`COB=0x000`, Data=`01 N`。
  - 402 使能三步（写 `0x6040 Controlword`，无故障前提）：
    1. `0x0006` → Ready to switch on
    2. `0x0007` → Switched on
    3. `0x000F` → Operation enabled
  - 如在 Fault：先 `Fault reset`（置位 bit7，常写 `0x0080` 或在当前值基础上置位），待 `0x6041` 清故障后再走三步。

- **3) 实时控制（是否需要 PDO？）**
  
  - 不强制，但强烈建议：
    - SDO 适合配置与偶发写；实时控制用 PDO 延迟小、开销低、易同步。
  - 快捷做法：
    - 许多驱动出厂就带默认 PDO 映射（TPDO1 含状态/位置，RPDO1 含控制/目标），你可直接用；若不符合需求再改映射。
  - 自定义（常用映射，示例）：
    - RPDO1：`0x6040 控制字`(16) + 目标值（PP: `0x607A`/32；PV: `0x60FF`/32；CST: `0x6071`/16）
    - TPDO1：`0x6041 状态字`(16) + `0x6064 实际位置`(32)
    - 配置步骤（对每个 PDO）：
      - 先把映射禁用：`0x1600:00 = 0`
      - 写映射项：如 `0x1600:01 = 0x60400010`（`index=0x6040, sub=0, len=16`）
      - 继续写下一个映射：如 `0x1600:02 = 0x607A0020`
      - 设置项数：`0x1600:00 = 2`
      - 通信参数：`0x1400:01 传输类型`（`1..240`=同步；`255`=事件/异步），`0x1400:05 事件定时`（ms，可选），`0x1400:01/03`等按需要设定；COB‑ID 通常维持默认（`RPDO1=0x200+N`，`TPDO1=0x180+N`）。
    - 如需时间对齐：配置 SYNC（`0x1005 COB-ID`，`0x1006 周期`），将 PDO 设为同步型，然后周期发送 `SYNC（COB=0x080）`。

- **4) 运行指令（按模式）**
  
  - PP（位置轮廓）：写目标位置（RPDO/SDO），再触发“新目标”位（Controlword 中的模式相关位，常为 bit4 上跳沿）。
  - PV：周期写 `0x60FF 目标速度`（建议 PDO）。
  - CSP/CSV/CST：每个控制周期通过 RPDO 写目标位置/速度/转矩；若为同步模式，用 SYNC 锁定周期。
  - 任何时刻可通过 `0x6040` 的 Halt/Enable bits 控制暂停/继续。

- **5) 反馈与监控（怎么接收？）**
  
  - 订阅 TPDO（如 `0x180+N`, `0x280+N` 等），解析你映射的对象：`0x6041 状态字`、`0x6064 实际位置`、`0x606C 实际速度`、`0x6077 实际转矩` 等。
  - 读状态/参数：任意时刻可 SDO 读（`0x580+N` 回）。
  - 心跳：监听 `0x700+N`，周期未到即离线判定。
  - 异常：监听 EMCY `0x080+N`，含错误码/寄存器；也可观察 `0x6041` 的 Fault 位。

### 极简示例（仅示意，NodeID=N）

- 设模式为 CSP=8（SDO 快速写1字节）：
  
  ```
  Tx: COB=0x600+N  Data=2F 60 60 00 08 00 00 00
  Rx: COB=0x580+N  Data=60 60 60 00 08 00 00 00
  ```

- 使能三步（通过 RPDO1 或 SDO，示意 SDO）：
  
  ```
  Tx: COB=0x600+N  Data=2B 40 60 00 06 00 00 00
  Tx: COB=0x600+N  Data=2B 40 60 00 07 00 00 00
  Tx: COB=0x600+N  Data=2B 40 60 00 0F 00 00 00
  ```

- 周期控制（CSP）：每周期写目标位置（RPDO1，COB=0x200+N），并（若同步）发 SYNC `COB=0x080` 触发。

### 常见注意

- SDO 配置期间建议处于 Pre‑op；完成后切 Operational 才会发送/接收 PDO。

- 具体单位、缩放、默认 PDO 映射和控制字位语义，务必以厂商 EDS/手册为准。

- Fault 状态必须先复位再使能；PDO/SDO 写失败时检查 NMT 状态与 0x6041。

- 如果你告诉我目标模式（PP/PV/CSP/CSV/CST）和 NodeID，我可以给出“可直接下发的最小帧序列”，按你的驱动默认映射或自定义映射两版。

- 变更/下一步：已提供从 NMT、SDO 配置、使能、PDO 实时控制到 TPDO 反馈的整体流程与关键对象、典型映射。你可据此实现基础控制与监测。

- 重点回顾
  
  - **配置（SDO）**：设 `0x6060`、必要运动参数、心跳、（可选）PDO 映射。
  - **使能**：`0x6040` 三步（故障先复位）。
  - **实时控制**：建议用 PDO；同步场景配 SYNC。
  - **反馈**：TPDO/SDO 读 + Heartbeat/EMCY 监控。


