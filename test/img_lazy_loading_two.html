<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>方案一</title>
</head>

<body>

    <div id="main">

    </div>

    <script defer>
        "use strict";

        // 图片url列表
        const images = [
            "https://img1.baidu.com/it/u=898692534,2766260827&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=500",
            "https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2F6e84bfe9-7926-4961-a270-a0189baed6c9%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1691232714&t=519337953111f86d70626770dffe92fa",
            "https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2F9191b4c3-ea6c-4e56-8e07-5c6de538d564%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1691232714&t=11b84733ecdf3f9d6ce6e937ca782c76",
            "https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2F8c153588-f486-44ed-8094-9029f7014471%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1691232714&t=7828109a55f7431ef6cf142b0cac0882",
            "https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2Fb888548a-1661-46b7-86ed-b730d32b2ed9%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1691232714&t=8ce249f6e13ac963e2a5fe5a2db6fcb5",
            "https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2F0c168a53-e715-4fce-96c7-5560f3c06b12%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1691232714&t=bfa97da64e214871082aa83f775fc35f",
            "https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2Ff538895d-f7b9-456c-be88-6c2a127f44ec%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1691232714&t=84cfc3499655c51cc72dd3eb8bfd6cea",
            "https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2Ffc2d272d-3899-4af7-a6b0-bcb640b9cdd2%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1691232714&t=d756e516080f8d2ae3fd887176aa36f2",
            "https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2Fa18d2b69-6105-4eb5-bab3-6190591fcbc0%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1691232714&t=034c8b885a2d1e825fd8ac6526735741",
            "https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2Fed5b61c0-85ae-433b-9feb-6e1161eace71%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1691232714&t=0fdd55298cf04faee785a08ace25844a",
        ];

        // 未加载时默认url
        const defaultUrl =
            "data:image/svg+xml;base64,PHN2ZyB0PSIxNjQ0ODk5MzI0NDgwIiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjIwOTMiIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48cGF0aCBkPSJNODc0LjEgODEzLjc1SDE0OS45Yy0yMi4yMiAwLTQwLjIzLTE4LjAxLTQwLjIzLTQwLjIzVjI1MC40OWMwLTIyLjIyIDE4LjAxLTQwLjIzIDQwLjIzLTQwLjIzaDcyNC4yYzIyLjIyIDAgNDAuMjMgMTguMDEgNDAuMjMgNDAuMjN2NTIzLjAzYzAgMjIuMjEtMTguMDIgNDAuMjMtNDAuMjMgNDAuMjN6TTI4MC42NiAzMTAuODRjLTM4Ljg5IDAtNzAuNDEgMzEuNTItNzAuNDEgNzAuNDFzMzEuNTIgNzAuNDEgNzAuNDEgNzAuNDEgNzAuNDEtMzEuNTIgNzAuNDEtNzAuNDEtMzEuNTItNzAuNDEtNzAuNDEtNzAuNDF6IG01MTIuOTcgMTAwLjU4YzAtMjIuMjItMTguMDEtNDAuMjMtNDAuMjMtNDAuMjNoLTQwLjIzYy02Ni42NiAwLTEyMC43IDU0LjA0LTEyMC43IDEyMC43djQwLjIzYzAgMzMuMzMtMjcuMDIgNjAuMzUtNjAuMzUgNjAuMzUtMTguMjkgMC0zNC40Ny04LjMxLTQ1LjU0LTIxLjE1LTAuMDUtMC4wNi0wLjI1LTAuMjgtMC4yOS0wLjMzLTIyLjA5LTI0LjA1LTU5Ljc3LTM4Ljg2LTk0Ljk4LTM4Ljg2LTAuNDQgMC0wLjg0IDAuMTItMS4yOCAwLjEzbC0wLjA2LTAuMDZjLTg4LjI2IDAuNzMtMTU5LjU5IDcyLjQ0LTE1OS41OSAxNjAuODYgMCAyMi4yMiAxOC4wMSA0MC4yMyA0MC4yMyA0MC4yM0g3NTMuNGMyMi4yMiAwIDQwLjIzLTE4LjAxIDQwLjIzLTQwLjIzVjQxMS40MnoiIHAtaWQ9IjIwOTQiIGZpbGw9IiNjZGNkY2QiPjwvcGF0aD48L3N2Zz4=";

        // 加载错误时代替
        const errorUrl =
            "data:image/svg+xml;base64,PHN2ZyB0PSIxNjQ0ODk5ODEzMDQ1IiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjQ0OTEiIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48cGF0aCBkPSJNNjQuMzgzMjM0IDUxMkM2NC4zODMyMzQgMjY0Ljc4NzgyOSAyNjQuNzg3ODI5IDY0LjM4MzIzNCA1MTIgNjQuMzgzMjM0IDc1OS4yMTIxNzEgNjQuMzgzMjM0IDk1OS42MTY3NjYgMjY0Ljc4NzgyOSA5NTkuNjE2NzY2IDUxMiA5NTkuNjE2NzY2IDc1OS4yMTIxNzEgNzU5LjIxMjE3MSA5NTkuNjE2NzY2IDUxMiA5NTkuNjE2NzY2IDI2NC43ODc4MjkgOTU5LjYxNjc2NiA2NC4zODMyMzQgNzU5LjIxMjE3MSA2NC4zODMyMzQgNTEyWk00NzQuMjMyMzc5IDc3MS4yNDUxMjRDNDc2LjQwODcxOCA3OTcuMzU1NTEyIDQ5MC41NTEzNzIgODEwLjQxMjEyMyA1MTYuNjYzMTc2IDgxMC40MTIxMjMgNTQyLjc3MzU2NCA4MTAuNDEyMTIzIDU1Ni45MTc2MzUgNzk3LjM1NTUxMiA1NTkuMDkyNTU2IDc3MS4yNDUxMjQgNTU2LjkxNzYzNSA3NDUuMTMzMzE5IDU0Mi43NzM1NjQgNzMwLjk5MDY2NiA1MTYuNjYzMTc2IDcyOC44MTQzMjcgNDkwLjU1MTM3MiA3MzAuOTkwNjY2IDQ3Ni40MDg3MTggNzQ1LjEzMzMxOSA0NzQuMjMyMzc5IDc3MS4yNDUxMjRaTTQ4MC43NTk5NzcgNjExLjMxNDc0OEM0ODAuNzU5OTc3IDYzNy40MjY1NTQgNDkyLjcyNzcxIDY1MC40ODE3NDcgNTE2LjY2MzE3NiA2NTAuNDgxNzQ3IDU0MC41OTcyMjYgNjUwLjQ4MTc0NyA1NTIuNTY0OTYgNjM3LjQyNjU1NCA1NTIuNTY0OTYgNjExLjMxNDc0OEw1NTIuNTY0OTYgMjQ5LjAyNDYxOEM1NTIuNTY0OTYgMjIyLjkxNDIzMSA1NDAuNTk3MjI2IDIwOS44NTc2MTkgNTE2LjY2MzE3NiAyMDkuODU3NjE5IDQ5Mi43Mjc3MSAyMDkuODU3NjE5IDQ4MC43NTk5NzcgMjIyLjkxNDIzMSA0ODAuNzU5OTc3IDI0OS4wMjQ2MThMNDgwLjc1OTk3NyA2MTEuMzE0NzQ4WiIgcC1pZD0iNDQ5MiIgZmlsbD0iI2NkY2RjZCI+PC9wYXRoPjwvc3ZnPg==";

        //加入一个节流
        function throttle(func, interval) {
            let lastTime = 0
            return function () {
                if (new Date() - lastTime > interval) {
                    lastTime = new Date();
                    func();
                }
            }
        }

        class scrollController {

            listener = new Set();

            constructor() {
                //监听
                //这里还需要做防抖
                document.addEventListener(`scroll`, throttle(this.scollHandler.bind(this), 500), {
                    capture: true,
                    passive: true,
                });
            }

            scollHandler() {
                //notify
                this.listener.forEach(obj => {
                    obj.notify();
                })
            }

            addListener(obj) {
                this.listener.add(obj);
            }

            //不些 remove 和 clear 之类的方法了
        }

        //img
        class ImgClass {
            clientPosition = [];
            dataUrl = "";
            blob = '';
            element = null;
            parent = null;
            active = false;

            constructor(url, parent = document.body) {
                this.dataUrl = url;
                this.parent = parent;
            }

            isInViewport() {

                return this.element.getBoundingClientRect().top < document.documentElement.clientHeight + 100;
                // let element = this.element;
                // const rect = element.getBoundingClientRect();
                // const windowHeight = window.innerHeight || document.documentElement.clientHeight;
                // const windowWidth = window.innerWidth || document.documentElement.clientWidth;

                // return (
                //     rect.top >= 0 &&
                //     rect.left >= 0 &&
                //     rect.bottom <= windowHeight &&
                //     rect.right <= windowWidth
                // );
            }

            showLoading() {
                this.element.src = defaultUrl;
            }

            showError() {
                this.element.src = errorUrl;
            }

            notify() {

                if (!!this.blob) return;
                if (this.active) return;
                let isIn = this.isInViewport();
                if (isIn) {
                    this.showImg();
                }
            }

            showImg() {
                const target = this;
                this.loadImage().then(() => {
                    this.element.src = target.blob;
                    this.active = false;
                })
            }


            buildDom() {
                const tDiv = document.createElement(`div`);
                const tImg = document.createElement('img');
                tImg.src = defaultUrl;
                tDiv.appendChild(tImg);
                this.element = tImg;
                this.parent.appendChild(tDiv);
            }

            loadImage() {

                if (!!this.blob) throw new Error(`已经加载过了`);

                if (this.dataUrl == '' || this.element == null) {
                    throw new Error(`数据不正确`);
                }

                if (typeof fetch !== 'function') {
                    throw new Error(`浏览器不支持fetch接口`);
                }

                const target = this;
                const myUrl = target.dataUrl;
                return fetch(myUrl)
                    .then(res => {
                        if (res.status === 200) {
                            return res.blob();
                        }
                        else return Promise.reject();
                    })
                    .then(blob => {
                        if (/image/.test(blob.type)) return URL.createObjectURL(blob);
                        else return Promise.reject();
                    })
                    .then((url) => {
                        target.blob = url;
                    })
                    .catch(() => {
                        target.showError();
                        this.active = false;
                        throw new Error("URL不正确或MIME类型不正确");
                    });
            }
        }

        let controller = new scrollController();

        images.forEach(imgUrl => {
            let i = new ImgClass(imgUrl);
            i.buildDom();
            controller.addListener(i);
        })
        controller.scollHandler();
    </script>
</body>

</html>