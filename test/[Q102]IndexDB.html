<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="./js/browser.js"></script>
</head>

<body>
    <h3>01. 浏览器信息</h3>
    <section id="browserInfo">

    </section>

    <h3>02. IndexDB信息</h3>
    <section id="indexDBInfo">

    </section>
    <p>estimate.quota 表示的是浏览器为当前站点分配的总存储空间限制。这个值在大多数情况下是准确的</p>

    <h3>03. 实时数据</h3>
    <section id="data">
        <h4>所有数据库</h4>
        <p id="databaseInfo">

        </p>
        <h4>当前选择的数据库</h4>
        <p id="curDataBaseInfo"></p>
    </section>

    <h3>04. 基本用法</h3>
    <section id="use">
        <p>
            <input type="text" id="databaseName" placeholder="请输入数据库名称">
            <input type="number" id="databaseVersion" placeholder="请输入数据库版本">
            <button onclick="createDataBase()">创建数据库</button>
        </p>
        <p>
            <label for="">请选择当前数据库</label> <select id="selectCurDataBase"
                onchange="selectCurDataBaseChange(this.value)"></select>
        </p>
        <p>
            <input type="text" id="objectStoreName" placeholder="请输入ObjectStore名称">
            <button onclick="createObjectStore()">创建对象存储</button>
        </p>
    </section>
    <script>
        const bsInfo = getBsInfo();
        let browserName = bsInfo.bs_name;
        let browserVersion = bsInfo.bs_version;

        console.log("浏览器名称: " + browserName);
        console.log("浏览器版本: " + browserVersion);
        const browserInfoElement = document.getElementById("browserInfo");
        const infoText = `浏览器名称: ${browserName}<br>浏览器版本: ${browserVersion}`;
        browserInfoElement.innerHTML = infoText;

        navigator.storage.estimate().then(function (estimate) {
            const usedSpaceInMB = estimate.usage / 1024;
            const totalSpaceInMB = estimate.quota / 1024 / 1024;
            const infoText = `
                <p>当前已使用 ${usedSpaceInMB}MB</p>
                <p>总空间大小 ${totalSpaceInMB}GB</p>
            `;
            document.getElementById('indexDBInfo').innerHTML = infoText;
        });

        let _databaseList = [];
        let _curDataBase = '';
        let _curVersion = -1;
        let _objectStoreList = [];

        function getDataBase() {
            return indexedDB.databases().then(function (databaseList) {
                return databaseList;
            }).catch(function (error) {
                console.error('Error listing databases: ', error);
            });
        }

        //----------- ui 代码
        function bindSelectDataBaseList(databaseList) {
            const selectElement = document.getElementById('selectCurDataBase');

            selectElement.innerHTML = '';

            const option = document.createElement('option');
            option.value = ""; // 设置<option>的值
            option.textContent = "空"; // 设置<option>的显示文本
            selectElement.appendChild(option);

            // 遍历数据数组并创建<option>元素并添加到<select>
            databaseList.forEach(function (item) {
                const option = document.createElement('option');
                option.value = item.name + "_" + item.version; // 设置<option>的值
                option.textContent = item.name + " " + item.version; // 设置<option>的显示文本
                selectElement.appendChild(option); // 将<option>添加到<select>
            });
        }

        function bindLastAllDataBaseInfo(databaseList) {
            let databaseInfo = document.getElementById("databaseInfo");
            let databaseInfoText = "";
            for (let i = 0; i < databaseList.length; i++) {
                let database = databaseList[i];
                databaseInfoText += `
                        <p>数据库名称: ${database.name} || 数据库版本: ${database.version}</p>
                        `;
            }
            databaseInfo.innerHTML = databaseInfoText
        }

        function bindCurDataBaseInfo(dataBaseName, version) {
            document.getElementById("curDataBaseInfo").innerHTML = `名称:${dataBaseName},版本:${version}`;
        }


        function bindHTML() {
            getDataBase().then(function (databaseList) {
                _databaseList = databaseList;
                console.log("数据库列表: " + JSON.stringify(databaseList));
                bindLastAllDataBaseInfo(databaseList);
                bindSelectDataBaseList(databaseList);
            });
        }
        bindHTML();

        //具体function
        function selectCurDataBaseChange(value) {
            _curDataBase = value.split('_')[0];
            _curVersion = Number(value.split('_')[1]);
            bindCurDataBaseInfo(_curDataBase, _curVersion);
        }

        function createObjectStore() {
            const name = document.getElementById("objectStoreName").value
            openIndexDB(_curDataBase, _curVersion, {
                onsuccess(event) {
                    const db = event.target.result;
                    const objectStore = db.createObjectStore(name, { keyPath: 'id', autoIncrement: true });
                    console.log(`创建ObjectStore ${name} 成功`)
                    db.close();
                }
            });
        }

        function getAllObjectStore(databaseName, version) {
            openIndexDB(databaseName, version, {
                onsuccess(event) {
                    const db = event.target.result;
                    const objectStoreNames = db.objectStoreNames;
                    _objectStoreList = objectStoreNames;
                    console.log(`ObjectStore列表：${_objectStoreList}`);
                    
                    db.close();
                },
            })
        }


        //indexDB Function
        function createObjectStore(objectStoreName, objectStoreParams) {
            if (!_curDataBase || _curDataBase == '') {
                alert('请选择数据库');
                return;
            }

            console.log("尝试打开数据库: " + objectStoreName)
            const dbOpenRequest = window.indexedDB.open(_curDataBase);
            dbOpenRequest.onsuccess()
        }

        function createDataBase() {
            let databaseName = document.getElementById("databaseName").value;
            let databaseVersion = document.getElementById("databaseVersion").value;
            openIndexDB(databaseName, Number(databaseVersion), {
                onupgradeneeded: function (event) {
                    alert(`创建数据库 ${databaseName} 成功`)
                    const db = event.target.result;
                    db.close();
                },
                onerror: function (event) {
                    debugger
                    alert(`创建数据库 ${databaseName} 失败`)
                }
            });
        }

        function openIndexDB(databaseName, version, params) {
            if (!databaseName || databaseName == '') {
                alert('请选择数据库');
                return;
            }

            if (typeof version !== 'number' || version < 1) {
                alert('请输入正确的版本号');
                return;
            }

            if (!params) params = {};

            console.log("尝试打开数据库: " + databaseName)
            const dbOpenRequest = window.indexedDB.open(databaseName, version);

            dbOpenRequest.onerror = function (event) {
                console.log(`触发onerror:${databaseName}`);
                if (params.onerror && typeof params.onerror === 'function') {
                    params.onerror(event);
                }
            };

            dbOpenRequest.onblocked = function (event) {
                console.log(`触发onblocked:${databaseName}`);
                if (params.onblocked && typeof params.onblocked === 'function') {
                    params.onblocked(event);
                }
            };

            dbOpenRequest.onsuccess = function (event) {
                console.log(`成功打开数据库:${databaseName}`);
                if (params.onsuccess && typeof params.onsuccess === 'function') {
                    params.onsuccess(event);
                }
            }

            dbOpenRequest.onupgradeneeded = function (event) {
                console.log(`数据库升级中, 触发onupgradeneeded事件`);
                if (params.onupgradeneeded && typeof params.onupgradeneeded === 'function') {
                    params.onupgradeneeded(event);
                }
            }
        }

    </script>
</body>

</html>