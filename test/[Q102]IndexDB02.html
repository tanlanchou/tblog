<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
</head>

<body>
  <script>
    function openIndexDB(databaseName, version, params) {
      if (!databaseName || databaseName == "") {
        alert("请选择数据库");
        return;
      }

      if (typeof version !== "number" || version < 1) {
        alert("请输入正确的版本号");
        return;
      }

      if (!params) params = {};

      console.log("尝试打开数据库: " + databaseName);
      const dbOpenRequest = window.indexedDB.open(databaseName, version);

      dbOpenRequest.onerror = function (event) {
        console.log(`触发onerror:${databaseName}`);
        if (params.onerror && typeof params.onerror === "function") {
          params.onerror(event);
        }
      };

      dbOpenRequest.onblocked = function (event) {
        console.log(`触发onblocked:${databaseName}`);
        if (params.onblocked && typeof params.onblocked === "function") {
          params.onblocked(event);
        }
      };

      dbOpenRequest.onsuccess = function (event) {
        console.log(`成功打开数据库:${databaseName}`);
        if (params.onsuccess && typeof params.onsuccess === "function") {
          params.onsuccess(event);
        }
      };

      dbOpenRequest.onupgradeneeded = function (event) {
        console.log(`数据库升级中, 触发onupgradeneeded事件`);
        if (
          params.onupgradeneeded &&
          typeof params.onupgradeneeded === "function"
        ) {
          params.onupgradeneeded(event);
        }
      };
    }

    function userAdd() {
      openIndexDB("test01", 1, {
        onsuccess: function (event) { },
        onupgradeneeded: function (event) {
          const db = event.target.result;
          const objectStore = db.createObjectStore("user", {
            keyPath: "id",
            autoIncrement: true,
          });

          objectStore.add({ name: "tommy", age: "18", sex: 1 });
          objectStore.add({ name: "tommy1", age: "19", sex: 0 });
          objectStore.add({ name: "tommy2", age: "20", sex: 1 });

          db.close();
        },
      });
    }

    function userDelete() {
      openIndexDB("test01", 1, {
        onsuccess: function (event) {
          const db = event.target.result;
          db.transaction();
        },
        onupgradeneeded: function (event) { },
      });
    }

    function userActionGetAll() {
      openIndexDB("test01", 1, {
        onsuccess: function (event) {
          const db = event.target.result;
          const transaction = db.transaction("user", "readonly");
          const objectStore = transaction.objectStore(`user`);
          const results = objectStore.getAll();
          results.onsuccess = function (event) {
            const r = event.target.result;
            if (r && r.length > 0) {
              r.forEach((item) => console.log(item.name));
            }
          };
        },
        onupgradeneeded: function (event) { },
      });
    }

    function userActionReadonlyAdd() {
      openIndexDB("test01", 1, {
        onsuccess: function (event) {
          const db = event.target.result;
          const transaction = db.transaction("user", "readonly");
          const objectStore = transaction.objectStore(`user`);

          const data = { name: "tommy3", age: "18", sex: 1 };
          objectStore.add(data);
          db.close();
        },
        onupgradeneeded: function (event) { },
      });
    }

    function userActionReadWriteGetAll() {
      // openIndexDB("test01", 1, {
      //   onsuccess: function (event) {
      //     const db = event.target.result;
      //     const transaction = db.transaction("user", "readwrite");
      //     const objectStore = transaction.objectStore(`user`);
      //     const results = objectStore.getAll();
      //     results.onsuccess = function (event) {
      //       const r = event.target.result;
      //       if (r && r.length > 0) {
      //         r.forEach((item) => console.log(item.name));
      //       }
      //     };
      //   },
      //   onupgradeneeded: function (event) { },
      // });

      openIndexDB("test01", 1, {
        onsuccess: function (event) {
          const db = event.target.result;
          const transaction = db.transaction("user", "readwrite");
          const objectStore = transaction.objectStore(`user`);

          const data = { name: "tommy3", age: "18", sex: 1 };
          objectStore.add(data);
          db.close();
        },
        onupgradeneeded: function (event) { },
      });
    }

    function userActionVersionChangeGetAll() {
      openIndexDB("test01", 1, {
        onsuccess: function (event) {
          const db = event.target.result;
          const transaction = db.transaction("user", "versionchange");
          const objectStore = transaction.objectStore(`user`);
          const results = objectStore.getAll();
          results.onsuccess = function (event) {
            const r = event.target.result;
            if (r && r.length > 0) {
              r.forEach((item) => console.log(item.name));
            }
          };
        },
        onupgradeneeded: function (event) { },
      });
    }

    function userActionVersionChange() {
      openIndexDB("test01", 2, {
        onsuccess: function (event) {
          const db = event.target.result;
          db.close();
        },
        onupgradeneeded: function (event) {
          const db = event.target.result;
          const transaction = event.currentTarget.transaction;
          const roleObjectStore = db.createObjectStore("role", { keyPath: "id", autoIncrement: true, });
          roleObjectStore.add({ "name": "admin", createTime: "2023-11-11" });
          roleObjectStore.add({ "name": "teacher", createTime: "2023-11-11" });
          roleObjectStore.add({ "name": "student", createTime: "2023-11-11" });

          const myStore = transaction.objectStore("user");
          myStore.openCursor().onsuccess = (event) => {
            const cursor = event.target.result;
            if (cursor) {
              const updateData = cursor.value;
              updateData.phone = `0000000` + updateData.id;
              cursor.update(updateData).onsuccess = () => {
                console.log(`${updateData.name}更新了数据`);
              }
              cursor.continue();
            } else {
              console.log("Entries all displayed.");
            }
          }
        },
      });
    }

    function userVersionOneGetAll() {
      openIndexDB("test01", 1, {
        onsuccess: function (event) {
          const db = event.target.result;
          const transaction = db.transaction("user", "readonly");
          const objectStore = transaction.objectStore(`user`);
          const results = objectStore.getAll();
          results.onsuccess = function (event) {
            const r = event.target.result;
            r.forEach(item => console.log(item));
          }
        }
      })
    }

    function userVersionTwoUserGetAll() {
      openIndexDB("test01", 2, {
        onsuccess: function (event) {
          const db = event.target.result;
          const transaction = db.transaction("user", "readonly");
          const objectStore = transaction.objectStore(`user`);
          const results = objectStore.getAll();
          results.onsuccess = function (event) {
            const r = event.target.result;
            r.forEach(item => console.log(item));
          }
        }
      })
    }

    function userVersionTwoRoleGetAll() {
      openIndexDB("test01", 2, {
        onsuccess: function (event) {
          const db = event.target.result;
          const transaction = db.transaction("role", "readonly");
          const objectStore = transaction.objectStore(`role`);
          const results = objectStore.getAll();
          results.onsuccess = function (event) {
            const r = event.target.result;
            r.forEach(item => console.log(item));
          }
        }
      })
    }

    //userAdd();
    //userVersionOneGetAll();
    //userActionVersionChange();
    // userVersionTwoUserGetAll();
    // userVersionTwoRoleGetAll();
    //userVersionOneGetAll();
    //userActionReadonlyAdd();
    userActionReadWriteGetAll(); 
  </script>
</body>

</html>