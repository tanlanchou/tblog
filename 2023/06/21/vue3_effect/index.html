<!DOCTYPE html>
<html lang="zh-Hans">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <meta name="description" content="vue3 effect" />
    <meta name="hexo-theme-A4" content="v1.7.0" />
    <link rel="alternate icon" type="image/webp" href="/img/favicon.webp">
    <title>æˆå¤©ä¹±å†™ | ä»£ç å’Œç”Ÿæ´»</title>

    
        
            
<link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/css/highlight/style1.css">

            
<link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/css/a11y-dark.min.css">

            
<link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/css/reset.css">

            
<link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/css/markdown.css">

            
<link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/css/fonts.css">
 
            <!--æ³¨æ„ï¼šé¦–é¡µæ—¢ä¸æ˜¯postä¹Ÿä¸æ˜¯page-->
            
                
<link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/css/waline.css">

            

            
<link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/css/ui.css">
 
            
<link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/css/style.css">

    
            <!--è¿”å›é¡¶éƒ¨css-->
            
                
<link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/css/returnToTop.css">

                
<link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/css/unicons.css">

            
            
                <!--ç›®å½•-->
                
<link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/css/toc.css">

            

        
    

    
        
<link rel="stylesheet" href="/css/returnToLastPage.css">

    
    
   
<link rel="stylesheet" href="/css/lightgallery-bundle.min.css">


<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="æˆå¤©ä¹±å†™" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>
    
    

    
    



    

    
    

    
    
    
    <body>
        <script src="/js/darkmode-js.min.js"></script>
        
        <script>
            const options = {
                bottom: '40px', // default: '32px'
                right: 'unset', // default: '32px'
                left: '42px', // default: 'unset'
                time: '0.3s', // default: '0.3s'
                mixColor: '#fff', // default: '#fff'
                backgroundColor: ' #e4e4e4 ',  // default: '#fff'
                buttonColorDark: '#100f2c',  // default: '#100f2c'
                buttonColorLight: '#fff', // default: '#fff'
                saveInCookies: true, // default: true,
                label: 'ğŸŒ“', // default: ''
                autoMatchOsTheme: true // default: true
            }
            const darkmode = new Darkmode(options);
            darkmode.showWidget();
        </script>
        
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    


<div class="header">
    <div class="header-container">
        <img style="
        width: 56px;
        height: auto;" alt="^-^" cache-control="max-age=86400" class="header-img" src="/img/favicon.webp" width="10%"></img>
        <div class="header-content">
            <a class="logo" href="/">æˆå¤©ä¹±å†™</a> 
            <span class="description">ä¹±å†™ä¸œè¥¿çš„åœ°æ–¹ï¼Œè®²è®²ä»£ç å’Œç”Ÿæ´»</span> 
        </div>
        
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">é¦–é¡µ</a></li>
            
        
            
                <li><a href="/list/">æ–‡ç« </a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--è¯´æ˜æ˜¯æ–‡ç« posté¡µé¢-->
                    
                        <div class="post-main">
    

    
        
            
                <div class="post-main-title" style="text-align: center;">
                    vue3 effect
                </div>
            
        
      
    

    

        
            <div class="post-head-meta-center">
        
                
                    <span>æœ€è¿‘æ›´æ–°ï¼š2024-12-02</span> 
                
                
                    
                        &nbsp; | &nbsp;
                    
                     <span>å­—æ•°æ€»è®¡ï¼š2.4k</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span>é˜…è¯»ä¼°æ—¶ï¼š11åˆ†é’Ÿ</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span id="busuanzi_container_page_pv">
                        é˜…è¯»é‡ï¼š<span id="busuanzi_value_page_pv"></span>æ¬¡
                    </span>
                
            </div>
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#vue3-effect"><span class="post-toc-text">vue3 effect</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#01-track"><span class="post-toc-text">01. track</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#02-triggger"><span class="post-toc-text">02. triggger</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#track-amp-trigger-%E6%80%BB%E7%BB%93"><span class="post-toc-text">track &amp; trigger æ€»ç»“</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#03-reactiveEffect-%E6%BA%90%E7%A0%81"><span class="post-toc-text">03. reactiveEffect æºç </span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#04-%E6%80%8E%E4%B9%88%E8%B0%83%E7%94%A8-reactiveEffect"><span class="post-toc-text">04. æ€ä¹ˆè°ƒç”¨ reactiveEffect</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#05-%E6%80%BB%E7%BB%93%E3%80%82"><span class="post-toc-text">05. æ€»ç»“ã€‚</span></a></li></ol></li></ol></li></ol>
            
        
        <h1 id="vue3-effect"><a href="#vue3-effect" class="headerlink" title="vue3 effect"></a>vue3 effect</h1><h3 id="01-track"><a href="#01-track" class="headerlink" title="01. track"></a>01. track</h3><p>ä»¥å“åº”å¼ä»£ç ä¸ºä¾‹å­</p>
<p><strong>packages&#x2F;reactivity&#x2F;src&#x2F;baseHandlers.ts</strong> ä¸­ <code>createGetter</code> è¯¥æ–¹æ³•ä¸º <code>Proxy</code> æä¾› <code>Getter</code> çš„å·¥å‚æ–¹æ³•</p>
<p>åœ¨åˆ¤æ–­ï¼Œç‰¹æ®Šè¿”å›å®Œæˆä¹‹åï¼Œä¼šè¿›è¡Œ <code>track</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!isReadonly) &#123;</span><br><span class="line">    <span class="title function_">track</span>(target, <span class="title class_">TrackOpTypes</span>.<span class="property">GET</span>, key)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>packages&#x2F;reactivity&#x2F;src&#x2F;effect.ts 214</strong></p>
<p>é¦–å…ˆä¼šåˆ¤æ–­ <code>houldTrack &amp;&amp; activeEffect</code>, è¿™é‡Œé»˜è®¤å®ƒä¸ºtrueï¼Œå› ä¸ºè¦è§£é‡Šæ˜¯å¦ä¸ºtrueï¼Œéœ€è¦çŸ¥é“åˆ›å»ºå’Œç»‘å®šçš„æµç¨‹ï¼Œä»¥åŠå®ƒçš„è§„åˆ™ã€‚</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (shouldTrack &amp;&amp; activeEffect) &#123; ... &#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ˜¯</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é€šè¿‡ target æŸ¥æ‰¾ targetMap è·å– depsMap</span></span><br><span class="line"><span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target)</span><br><span class="line"><span class="comment">//å¦‚æœæ²¡æœ‰ï¼Œæ–°å»ºMapï¼Œå¹¶ä¸”èµ‹å€¼ depsMap</span></span><br><span class="line"><span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">    targetMap.<span class="title function_">set</span>(target, (depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>()))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//depsMap é€šè¿‡ Key è·å–ã€‚</span></span><br><span class="line"><span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key)</span><br><span class="line"><span class="comment">//å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Depï¼Œ Dep æ˜¯ Set &amp; TrackedMarkers</span></span><br><span class="line"><span class="keyword">if</span> (!dep) &#123;</span><br><span class="line">    depsMap.<span class="title function_">set</span>(key, (dep = <span class="title function_">createDep</span>()))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·Ÿè¸ª Effects</span></span><br><span class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦éœ€è¦ track</span></span><br><span class="line"><span class="comment">//ç›¸äº’å¼•ç”¨</span></span><br><span class="line"><span class="title function_">trackEffects</span>(dep, eventInfo)</span><br></pre></td></tr></table></figure>

<p><code>targetMap</code> </p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">KeyToDepMap</span> = <span class="title class_">Map</span>&lt;<span class="built_in">any</span>, <span class="title class_">Dep</span>&gt;</span><br><span class="line"><span class="keyword">const</span> targetMap = <span class="keyword">new</span> <span class="title class_">WeakMap</span>&lt;<span class="built_in">any</span>, <span class="title class_">KeyToDepMap</span>&gt;()</span><br></pre></td></tr></table></figure>

<p>å®šä¹‰ <code>target =&gt; key =&gt; Dep</code> çš„ä¸€ä¸ªæ˜ å°„è¡¨ï¼Œé€šè¿‡ä»–æ¥å­˜å‚¨ä¹‹é—´çš„å…³ç³»ã€‚<br>å…¶ä¸­ <code>KeyToDepMap</code> å°±æ˜¯ <code>depsMap</code>, æœ€ç»ˆå­˜å‚¨ <code>Dep</code></p>
<p>Dep æ˜¯ä¸€ä¸ª </p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">Dep</span> = <span class="title class_">Set</span>&lt;<span class="title class_">ReactiveEffect</span>&gt; &amp; <span class="title class_">TrackedMarkers</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">TrackedMarkers</span> = &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * wasTracked</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">w</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * newTracked</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">n</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>trackEffects</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">trackEffects</span>(<span class="params"></span></span><br><span class="line"><span class="params">  dep: Dep,</span></span><br><span class="line"><span class="params">  debuggerEventExtraInfo?: DebuggerEventExtraInfo</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">let</span> shouldTrack = <span class="literal">false</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">//å…ˆä¸ç”¨çº ç»“ä»–æ€ä¹ˆç®—çš„</span></span><br><span class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦è¶…è¿‡æœ€å¤§æ•°å€¼</span></span><br><span class="line"><span class="comment">//å¦‚æœæ²¡æœ‰è¶…è¿‡ï¼Œå°±æ˜¯éƒ¨åˆ†æ¸…ç†</span></span><br><span class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦è¢«å…¶ä»– ReactiveEffect è®¿é—®</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">dep.<span class="title function_">add</span>(activeEffect!) <span class="comment">//depå¢åŠ  Effect</span></span><br><span class="line">activeEffect!.<span class="property">deps</span>.<span class="title function_">push</span>(dep) <span class="comment">//activeEffect.depså¢åŠ dep</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸€éƒ¨åˆ†å°±æ˜¯å¢åŠ  track çš„ä»£ç ï¼Œæ€»ä¹‹å°±æ˜¯åœ¨ <code>dep</code> å’Œ <code>effect</code> ç›¸äº’å…³è”, dep åœ¨ targetMap ä¸­ã€‚</p>
<h3 id="02-triggger"><a href="#02-triggger" class="headerlink" title="02. triggger"></a>02. triggger</h3><p><code>triggger function</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params"></span></span><br><span class="line"><span class="params">  target: <span class="built_in">object</span>,</span></span><br><span class="line"><span class="params">  <span class="keyword">type</span>: TriggerOpTypes,</span></span><br><span class="line"><span class="params">  key?: <span class="built_in">unknown</span>,</span></span><br><span class="line"><span class="params">  newValue?: <span class="built_in">unknown</span>,</span></span><br><span class="line"><span class="params">  oldValue?: <span class="built_in">unknown</span>,</span></span><br><span class="line"><span class="params">  oldTarget?: <span class="built_in">Map</span>&lt;<span class="built_in">unknown</span>, <span class="built_in">unknown</span>&gt; | <span class="built_in">Set</span>&lt;<span class="built_in">unknown</span>&gt;</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//å¦‚æœæ²¡æœ‰ä» targetMap.get è·å–åˆ°ï¼Œæ²¡æœ‰ track</span></span><br><span class="line">  <span class="keyword">const</span> depsMap = targetMap.<span class="title function_">get</span>(target)</span><br><span class="line">  <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">    <span class="comment">// never been tracked</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//Dep[]</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">deps</span>: (<span class="title class_">Dep</span> | <span class="literal">undefined</span>)[] = []</span><br><span class="line">  <span class="comment">//å¦‚æœ type æ˜¯ CLEARï¼Œè¡¨ç¤ºæ¸…ç©ºé›†åˆï¼Œå°† depsMap ä¸­æ‰€æœ‰çš„ä¾èµ–é¡¹éƒ½åŠ å…¥åˆ° deps ä¸­</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">type</span> === <span class="title class_">TriggerOpTypes</span>.<span class="property">CLEAR</span>) &#123;</span><br><span class="line">    <span class="comment">// collection being cleared</span></span><br><span class="line">    <span class="comment">// trigger all effects for target</span></span><br><span class="line">    deps = [...depsMap.<span class="title function_">values</span>()]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//å¦‚æœ key æ˜¯ lengthï¼Œå¹¶ä¸” target æ˜¯æ•°ç»„ï¼Œåˆ™è¡¨ç¤ºæ•°ç»„é•¿åº¦å‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦è§¦å‘æ•°ç»„çš„ä¾èµ–é¡¹æ›´æ–°ã€‚</span></span><br><span class="line">  <span class="comment">//æ‰¾åˆ° depsMap ä¸­ key ç­‰äº length æˆ–è€…å¤§äºç­‰äºæ–°é•¿åº¦çš„ä¾èµ–é¡¹ï¼Œå¹¶å°†å…¶åŠ å…¥åˆ° deps ä¸­ã€‚</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (key === <span class="string">&#x27;length&#x27;</span> &amp;&amp; <span class="title function_">isArray</span>(target)) &#123;</span><br><span class="line">    <span class="keyword">const</span> newLength = <span class="title class_">Number</span>(newValue)</span><br><span class="line">    depsMap.<span class="title function_">forEach</span>(<span class="function">(<span class="params">dep, key</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (key === <span class="string">&#x27;length&#x27;</span> || key &gt;= newLength) &#123;</span><br><span class="line">        deps.<span class="title function_">push</span>(dep)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// schedule runs for SET | ADD | DELETE</span></span><br><span class="line">    <span class="comment">//key !== undefined</span></span><br><span class="line">    <span class="keyword">if</span> (key !== <span class="built_in">void</span> <span class="number">0</span>) &#123;</span><br><span class="line">      deps.<span class="title function_">push</span>(depsMap.<span class="title function_">get</span>(key))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// also run for iteration key on ADD | DELETE | Map.SET</span></span><br><span class="line">    <span class="comment">// å¯¹äº SETã€ADDã€DELETE ä¸‰ç§æƒ…å†µï¼Œæ ¹æ® key ä» depsMap ä¸­è·å–ä¾èµ–é¡¹ depï¼Œå¹¶å°†å…¶åŠ å…¥åˆ° deps ä¸­</span></span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">TriggerOpTypes</span>.<span class="property">ADD</span>:</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_">isArray</span>(target)) &#123;</span><br><span class="line">          <span class="comment">//å¯¹äº ADD æ“ä½œï¼Œå¦‚æœ target ä¸æ˜¯æ•°ç»„ï¼Œåˆ™éœ€è¦è§¦å‘ ITERATE_KEY å’Œ MAP_KEY_ITERATE_KEY ä¸¤ä¸ªè¿­ä»£ä¾èµ–é¡¹æ›´æ–°</span></span><br><span class="line">          deps.<span class="title function_">push</span>(depsMap.<span class="title function_">get</span>(<span class="variable constant_">ITERATE_KEY</span>))</span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">isMap</span>(target)) &#123;</span><br><span class="line">            deps.<span class="title function_">push</span>(depsMap.<span class="title function_">get</span>(<span class="variable constant_">MAP_KEY_ITERATE_KEY</span>))</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœ target æ˜¯æ•°ç»„ï¼Œä¸” key æ˜¯æ•´æ•°ï¼Œåˆ™éœ€è¦è§¦å‘æ•°ç»„é•¿åº¦çš„ä¾èµ–é¡¹æ›´æ–°ã€‚ </span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isIntegerKey</span>(key)) &#123;</span><br><span class="line">          <span class="comment">// new index added to array -&gt; length changes</span></span><br><span class="line">          deps.<span class="title function_">push</span>(depsMap.<span class="title function_">get</span>(<span class="string">&#x27;length&#x27;</span>))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">TriggerOpTypes</span>.<span class="property">DELETE</span>:</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_">isArray</span>(target)) &#123;</span><br><span class="line">          <span class="comment">//å¦‚æœ target ä¸æ˜¯æ•°ç»„ï¼Œåˆ™éœ€è¦è§¦å‘ ITERATE_KEY</span></span><br><span class="line">          deps.<span class="title function_">push</span>(depsMap.<span class="title function_">get</span>(<span class="variable constant_">ITERATE_KEY</span>))</span><br><span class="line">          <span class="comment">//å¦‚æœæ˜¯Mapï¼ŒMAP_KEY_ITERATE_KEY</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">isMap</span>(target)) &#123;</span><br><span class="line">            deps.<span class="title function_">push</span>(depsMap.<span class="title function_">get</span>(<span class="variable constant_">MAP_KEY_ITERATE_KEY</span>))</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">TriggerOpTypes</span>.<span class="property">SET</span>:</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isMap</span>(target)) &#123;</span><br><span class="line">          deps.<span class="title function_">push</span>(depsMap.<span class="title function_">get</span>(<span class="variable constant_">ITERATE_KEY</span>))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> eventInfo = __DEV__</span><br><span class="line">    ? &#123; target, <span class="keyword">type</span>, key, newValue, oldValue, oldTarget &#125;</span><br><span class="line">    : <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//å¦‚æœåªæœ‰ä¸€ä¸ª depï¼Œç›´æ¥æ›´æ–°</span></span><br><span class="line">  <span class="comment">//å¦‚æœå¤šä¸ª åˆ™éœ€è¦å°†æ‰€æœ‰ä¾èµ–é¡¹çš„ ReactiveEffect å¯¹è±¡åˆå¹¶æˆä¸€ä¸ªæ–°çš„ ReactiveEffect å¯¹è±¡ï¼Œå†æ›´æ–°</span></span><br><span class="line">  <span class="keyword">if</span> (deps.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (deps[<span class="number">0</span>]) &#123;</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        <span class="title function_">triggerEffects</span>(deps[<span class="number">0</span>], eventInfo)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">triggerEffects</span>(deps[<span class="number">0</span>])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">effects</span>: <span class="title class_">ReactiveEffect</span>[] = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> dep <span class="keyword">of</span> deps) &#123;</span><br><span class="line">      <span class="keyword">if</span> (dep) &#123;</span><br><span class="line">        effects.<span class="title function_">push</span>(...dep)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="title function_">triggerEffects</span>(<span class="title function_">createDep</span>(effects), eventInfo)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">triggerEffects</span>(<span class="title function_">createDep</span>(effects))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹èµ·æ¥ä»£ç å¾ˆå¤šï¼Œå…¶å®åšäº†å‡ ä»¶äº‹ã€‚</p>
<ol>
<li>å¤„ç† type.clear</li>
<li>å¤„ç† arr &amp; key &#x3D; length or number çš„é—®é¢˜</li>
<li>deps &#x3D; Dep[], å¦‚æœ Key !&#x3D; undefined æŠŠå¯¹åº” keyï¼Œä»¥åŠæ ¹æ®type è·å–å¯¹åº”Dep</li>
<li>triggerEffects å¤„ç†</li>
</ol>
<p><strong>triggerEffects</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">triggerEffects</span>(<span class="params"></span></span><br><span class="line"><span class="params">  dep: Dep | ReactiveEffect[],</span></span><br><span class="line"><span class="params">  debuggerEventExtraInfo?: DebuggerEventExtraInfo</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// spread into array for stabilization</span></span><br><span class="line">  <span class="keyword">const</span> effects = <span class="title function_">isArray</span>(dep) ? dep : [...dep]</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> effect <span class="keyword">of</span> effects) &#123;</span><br><span class="line">    <span class="keyword">if</span> (effect.<span class="property">computed</span>) &#123;</span><br><span class="line">      <span class="title function_">triggerEffect</span>(effect, debuggerEventExtraInfo)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> effect <span class="keyword">of</span> effects) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!effect.<span class="property">computed</span>) &#123;</span><br><span class="line">      <span class="title function_">triggerEffect</span>(effect, debuggerEventExtraInfo)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡éå† <code>dep</code>, <code>triggerEffect(effect)</code>, å…ˆå¤„ç† <code>computed</code>, ç„¶åé <code>computed</code></p>
<p><strong>triggerEffect</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">triggerEffect</span>(<span class="params"></span></span><br><span class="line"><span class="params">  effect: ReactiveEffect,</span></span><br><span class="line"><span class="params">  debuggerEventExtraInfo?: DebuggerEventExtraInfo</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (effect !== activeEffect || effect.<span class="property">allowRecurse</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; effect.<span class="property">onTrigger</span>) &#123;</span><br><span class="line">      effect.<span class="title function_">onTrigger</span>(<span class="title function_">extend</span>(&#123; effect &#125;, debuggerEventExtraInfo))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (effect.<span class="property">scheduler</span>) &#123;</span><br><span class="line">      effect.<span class="title function_">scheduler</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      effect.<span class="title function_">run</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è§¦å‘ <code>ReactiveEffect</code> æœ‰ <code>scheduler</code> ä¼˜å…ˆ <code>scheduler</code>ï¼Œæ²¡æœ‰ <code>run</code></p>
<h3 id="track-amp-trigger-æ€»ç»“"><a href="#track-amp-trigger-æ€»ç»“" class="headerlink" title="track &amp; trigger æ€»ç»“"></a>track &amp; trigger æ€»ç»“</h3><ol>
<li>trackï¼Œåˆ›å»ºDepï¼Œå¹¶ä¸”æ”¾å…¥ targetMap &amp; desMap, Dep æ·»åŠ  activeEffectï¼Œ activeEffect.deps.push(dep)</li>
<li>trigger, è·å– target çš„ depsMap, æ’é™¤ type.clear &amp; key &#x3D; length &amp; number, å¦‚æœæœ‰key ä» depsMap è·å–, ç„¶åå†æŠŠå¯¹åº”typeçš„ä¸€äº›å›ºå®škeyï¼Œä¹Ÿè·å–å‡ºæ¥ï¼Œç„¶å effect.scheduler or run, computed ä¼˜å…ˆã€‚</li>
</ol>
<h3 id="03-reactiveEffect-æºç "><a href="#03-reactiveEffect-æºç " class="headerlink" title="03. reactiveEffect æºç "></a>03. reactiveEffect æºç </h3><p>ä¹‹å‰è¯´äº†è¿™ä¹ˆå¤šï¼Œå…¶å® track å’Œ trigger éƒ½æ˜¯ä¸ºäº†è§¦å‘ reactiveEffect æ›´æ–°ï¼Œé‚£ä¹ˆç»§ç»­çœ‹ä¸€ä¸‹</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReactiveEffect ç±»å®šä¹‰</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ReactiveEffect</span>&lt;T = <span class="built_in">any</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// æ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œåˆå§‹ä¸º true</span></span><br><span class="line">  active = <span class="literal">true</span></span><br><span class="line">  <span class="comment">// å½“å‰ ReactiveEffect å®ä¾‹çš„ä¾èµ–é¡¹æ•°ç»„</span></span><br><span class="line">  <span class="attr">deps</span>: <span class="title class_">Dep</span>[] = []</span><br><span class="line">  <span class="comment">// å½“å‰ ReactiveEffect å®ä¾‹çš„çˆ¶çº§ ReactiveEffect å®ä¾‹ï¼Œç”¨äºè§£å†³é€’å½’è°ƒç”¨çš„é—®é¢˜</span></span><br><span class="line">  <span class="attr">parent</span>: <span class="title class_">ReactiveEffect</span> | <span class="literal">undefined</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¯ä»¥åœ¨åˆ›å»ºä¹‹åé™„åŠ </span></span><br><span class="line">  computed?: <span class="title class_">ComputedRefImpl</span>&lt;T&gt;</span><br><span class="line">  <span class="comment">// å…è®¸é€’å½’è°ƒç”¨</span></span><br><span class="line">  allowRecurse?: <span class="built_in">boolean</span></span><br><span class="line">  <span class="comment">// å»¶è¿Ÿåœæ­¢ï¼Œç”¨äºé¿å…å› åˆ é™¤å½“å‰ ReactiveEffect å®ä¾‹æ—¶å¼•èµ·çš„å¹¶å‘é—®é¢˜</span></span><br><span class="line">  <span class="keyword">private</span> deferStop?: <span class="built_in">boolean</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å½“ ReactiveEffect å®ä¾‹åœæ­¢æ—¶è°ƒç”¨çš„å‡½æ•°</span></span><br><span class="line">  onStop?: <span class="function">() =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// ä»…åœ¨å¼€å‘ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œç”¨äºè·Ÿè¸ªä¾èµ–é¡¹è¿½è¸ªäº‹ä»¶</span></span><br><span class="line">  onTrack?: <span class="function">(<span class="params">event: DebuggerEvent</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  <span class="comment">// ä»…åœ¨å¼€å‘ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œç”¨äºè·Ÿè¸ªè§¦å‘äº‹ä»¶</span></span><br><span class="line">  onTrigger?: <span class="function">(<span class="params">event: DebuggerEvent</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ReactiveEffect æ„é€ å‡½æ•°</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">public</span> fn: () =&gt; T, <span class="comment">// å½“å‰ ReactiveEffect å®ä¾‹çš„æ‰§è¡Œå‡½æ•°</span></span></span><br><span class="line"><span class="params">    <span class="keyword">public</span> scheduler: EffectScheduler | <span class="literal">null</span> = <span class="literal">null</span>, <span class="comment">// ç”¨äºæŒ‡å®šæ›´æ–°ç­–ç•¥</span></span></span><br><span class="line"><span class="params">    scope?: EffectScope <span class="comment">// ç”¨äºæŒ‡å®šä½œç”¨åŸŸ</span></span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="title function_">recordEffectScope</span>(<span class="variable language_">this</span>, scope) <span class="comment">// è®°å½•å½“å‰ ReactiveEffect å®ä¾‹çš„ä½œç”¨åŸŸ</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿è¡Œ ReactiveEffect å®ä¾‹</span></span><br><span class="line">  <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">active</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">fn</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦å·²ç»è¿½è¸ªäº†å½“å‰ ReactiveEffect å®ä¾‹</span></span><br><span class="line">    <span class="keyword">let</span> <span class="attr">parent</span>: <span class="title class_">ReactiveEffect</span> | <span class="literal">undefined</span> = activeEffect</span><br><span class="line">    <span class="keyword">let</span> lastShouldTrack = shouldTrack</span><br><span class="line">    <span class="keyword">while</span> (parent) &#123;</span><br><span class="line">      <span class="keyword">if</span> (parent === <span class="variable language_">this</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      parent = parent.<span class="property">parent</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// è®¾ç½®çˆ¶çº§ ReactiveEffect å®ä¾‹ï¼Œå¹¶å°†å½“å‰å®ä¾‹è®¾ç½®ä¸º activeEffect</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">parent</span> = activeEffect</span><br><span class="line">      activeEffect = <span class="variable language_">this</span></span><br><span class="line">      shouldTrack = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// åˆå§‹åŒ– depMarkersï¼Œç”¨äºæ€§èƒ½ä¼˜åŒ–</span></span><br><span class="line">      trackOpBit = <span class="number">1</span> &lt;&lt; ++effectTrackDepth</span><br><span class="line">      <span class="keyword">if</span> (effectTrackDepth &lt;= maxMarkerBits) &#123;</span><br><span class="line">        <span class="title function_">initDepMarkers</span>(<span class="variable language_">this</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">cleanupEffect</span>(<span class="variable language_">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ‰§è¡Œ ReactiveEffect å®ä¾‹çš„å‡½æ•°</span></span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">fn</span>()</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// ç»“æŸè¿½è¸ª depMarkers</span></span><br><span class="line">      <span class="keyword">if</span> (effectTrackDepth &lt;= maxMarkerBits) &#123;</span><br><span class="line">        <span class="title function_">finalizeDepMarkers</span>(<span class="variable language_">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      trackOpBit = <span class="number">1</span> &lt;&lt; --effectTrackDepth</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ¢å¤ä¸Šä¸€ä¸ªæ´»åŠ¨çš„ ReactiveEffect å®ä¾‹</span></span><br><span class="line">      activeEffect = <span class="variable language_">this</span>.<span class="property">parent</span></span><br><span class="line">      shouldTrack = lastShouldTrack</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">parent</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¦‚æœ deferStop å±æ€§ä¸º trueï¼Œåˆ™åˆ é™¤å½“å‰ ReactiveEffect å®ä¾‹</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">deferStop</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">stop</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">stop</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰å‰¯ä½œç”¨å‡½æ•°æ­£åœ¨æ‰§è¡Œï¼Œæ ‡è®°ä¸ºå»¶è¿Ÿæ¸…ç†</span></span><br><span class="line">    <span class="keyword">if</span> (activeEffect === <span class="variable language_">this</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">deferStop</span> = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">active</span>) &#123; <span class="comment">// å¦‚æœå½“å‰å‰¯ä½œç”¨å‡½æ•°æœªæ‰§è¡Œä¸”ä»ç„¶æ´»è·ƒ</span></span><br><span class="line">        <span class="title function_">cleanupEffect</span>(<span class="variable language_">this</span>) <span class="comment">// æ¸…é™¤å‰¯ä½œç”¨å‡½æ•°ä¸å…¶ä¾èµ–é¡¹ä¹‹é—´çš„å…³è”å…³ç³»</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">onStop</span>) &#123; <span class="comment">// å¦‚æœæœ‰åœæ­¢å›è°ƒå‡½æ•°ï¼Œè°ƒç”¨åœæ­¢å›è°ƒå‡½æ•°</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">onStop</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">active</span> = <span class="literal">false</span> <span class="comment">// æ ‡è®°å½“å‰å‰¯ä½œç”¨å‡½æ•°ä¸ºä¸æ´»è·ƒçŠ¶æ€</span></span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æä¾›äº†3ä¸ªæ–¹æ³•ï¼Œæ„é€ ï¼Œ<code>run</code>ï¼Œ<code>stop</code></p>
<ol>
<li>æ„é€ å‡½æ•°ï¼Œ å°±æ˜¯å¦‚æœ <code>!!scope</code>, <code>scope.effects.push(this)</code>, è¿˜æœ‰ä¸€ä¸ª <code>EffectScope</code>ï¼Œå°±æ˜¯è¿™ä¸ª <code>scope</code>ï¼Œç”¨äºç®¡ç† <code>reactiveEffect</code>, è¿™é‡ŒæŠŠä»–æ”¾è¿›ç®¡ç†é‡Œé¢å»</li>
<li>run å¯ä»¥ç®€å•çš„ç†è§£ä¸ºæ‰§è¡Œæ„é€ å‡½æ•°ä¼ å…¥çš„ <code>Fn</code> å‡½æ•°<br>  2.1 å¤æ‚ä¸€ç‚¹è¯´ï¼Œå½“ <code>!active</code>, ç›´æ¥è°ƒç”¨ <code>fn</code><br>  2.2 æ£€æŸ¥ parent æ˜¯å¦å­˜åœ¨å¾ªç¯å¼•ç”¨<br>  2.3 è®¾ç½®å‚æ•°ï¼Œ<code>parent = activeEffect, activeEffect = this, shouldTrack = true</code><br>  2.4 <code>fn()</code><br>  2.5 æ¢å¤å‚æ•° <code>activeEffect = this.parentï¼ŒshouldTrack = lastShouldTrackï¼Œthis.parent = undefined</code></li>
</ol>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªæ¦‚å¿µ</p>
<blockquote>
<p>depMarkers æ˜¯ä¸€ä¸ªç”¨äºè¿½è¸ªä¾èµ–å…³ç³»çš„æ ‡è®°å¯¹è±¡ï¼Œç”¨äºåœ¨ reactive effect ä¸­è®°å½•å“ªäº›ä¾èµ–é¡¹å·²è¢«è¿½è¸ªè¿‡ã€‚å®ƒæœ‰ä¸¤ä¸ªå±æ€§ w å’Œ nï¼Œåˆ†åˆ«ä»£è¡¨äº† â€œwasTrackedâ€ å’Œ â€œnewTrackedâ€ã€‚</p>
<p>åœ¨ reactive effect ä¸­ï¼ŒdepMarkers è¢«ç”¨æ¥åˆ¤æ–­æŸä¸ªä¾èµ–é¡¹æ˜¯å¦å·²è¢«è¿½è¸ªï¼Œä»¥åŠåœ¨è¿½è¸ªå®Œæ‰€æœ‰ä¾èµ–é¡¹åæ˜¯å¦æœ‰æ–°çš„ä¾èµ–é¡¹è¢«è¿½è¸ªã€‚å¦‚æœä¸€ä¸ªä¾èµ–é¡¹åœ¨ reactive effect ä¸­è¢«è¿½è¸ªè¿‡ï¼Œå®ƒçš„ w ä½ä¼šè¢«è®¾ç½®ä¸º 1ï¼Œå¦‚æœåœ¨å½“å‰è¿½è¸ªè¿‡ç¨‹ä¸­æœ‰æ–°çš„ä¾èµ–é¡¹è¢«è¿½è¸ªï¼Œå®ƒçš„ n ä½ä¼šè¢«è®¾ç½®ä¸º 1ã€‚</p>
<p>é€šè¿‡ depMarkers ä¸­çš„è¿™äº›æ ‡è®°ï¼ŒVue3 å¯ä»¥åœ¨ reactive effect ä¸­è·Ÿè¸ªä¾èµ–é¡¹çš„å˜åŒ–ï¼Œå¹¶ä¸”åªä¼šåœ¨å¿…è¦çš„æ—¶å€™é‡æ–°è¿è¡Œ reactive effectã€‚è¿™æ ·å¯ä»¥æé«˜æ€§èƒ½å’Œå“åº”é€Ÿåº¦ã€‚</p>
</blockquote>
<p>è¿™é‡Œå…ˆä¸å±•å¼€äº†</p>
<ol start="3">
<li><code>stop</code> å°±æ˜¯æ¸…ç† <code>effect</code> å’Œ <code>dep</code> çš„å…³è”ï¼Œå…¨éƒ¨<code>delete</code>ï¼Œ<code>active</code> è®¾ç½®ä¸º <code>false</code></li>
</ol>
<h3 id="04-æ€ä¹ˆè°ƒç”¨-reactiveEffect"><a href="#04-æ€ä¹ˆè°ƒç”¨-reactiveEffect" class="headerlink" title="04. æ€ä¹ˆè°ƒç”¨ reactiveEffect"></a>04. æ€ä¹ˆè°ƒç”¨ reactiveEffect</h3><p>è¿™é‡Œæˆ‘äº§ç”Ÿäº†ä¸€ä¸ªç–‘æƒ‘ï¼Œåœ¨è¿™ä¸ªè§¦å‘çš„è¿‡ç¨‹ä¸­ï¼ŒactiveEffect, æ˜¯ä»€ä¹ˆæ—¶å€™å®ä¾‹åŒ–çš„ï¼Ÿæˆ‘æŸ¥çœ‹äº†æ‰€æœ‰å…³äº <code>activeEffect</code> çš„å¼•ç”¨ã€‚</p>
<p>åªæœ‰åœ¨ <code>reactiveEffect.run</code> ä¸­æ‰æœ‰è®¾ç½®</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">parent</span> = activeEffect</span><br><span class="line">activeEffect = <span class="variable language_">this</span></span><br><span class="line">shouldTrack = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">activeEffect = <span class="variable language_">this</span>.<span class="property">parent</span></span><br><span class="line">shouldTrack = lastShouldTrack</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">parent</span> = <span class="literal">undefined</span></span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´å½“ä¸€ä¸ª, æˆ‘ä»¬å¯ä»¥ç†è§£ <code>reactiveEffect</code> æ˜¯ä¸€ä¸ªæ ‘ï¼Œä¿è¯è¿è¡Œæ—¶å€™ç±»ä¼¼äºå…ˆè¿›åå‡ºã€‚</p>
<p>è¿™é‡Œè§£é‡Šäº†ä¸ºä»€ä¹ˆ <code>activeEffect</code> ä¼šä¿è¯æœ‰å€¼çš„åŸå› ã€‚</p>
<p>å¦å¤–æˆ‘ä»¬æ€»æ˜¯éœ€è¦å…ˆè°ƒç”¨ <code>reactiveEffect</code>, æ‰ä¼šæœ‰ç¬¬ä¸€æ¬¡çš„å€¼, è¿™é‡Œæ˜¯åœ¨åˆå§‹åŒ–ç»„ä»¶æˆ–è€…æ›´æ–°ç»„ä»¶çš„æ—¶å€™</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create reactive effect for rendering</span></span><br><span class="line"><span class="keyword">const</span> effect = (instance.<span class="property">effect</span> = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(</span><br><span class="line">  componentUpdateFn,</span><br><span class="line">  <span class="function">() =&gt;</span> <span class="title function_">queueJob</span>(update),</span><br><span class="line">  instance.<span class="property">scope</span> <span class="comment">// track it in component&#x27;s effect scope</span></span><br><span class="line">))</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">update</span>: <span class="title class_">SchedulerJob</span> = (instance.<span class="property">update</span> = <span class="function">() =&gt;</span> effect.<span class="title function_">run</span>())</span><br><span class="line">update.<span class="property">id</span> = instance.<span class="property">uid</span></span><br><span class="line"><span class="comment">// allowRecurse</span></span><br><span class="line"><span class="comment">// #1801, #2043 component render effects should allow recursive updates</span></span><br><span class="line"><span class="title function_">toggleRecurse</span>(instance, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">  effect.<span class="property">onTrack</span> = instance.<span class="property">rtc</span></span><br><span class="line">    ? <span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">invokeArrayFns</span>(instance.<span class="property">rtc</span>!, e)</span><br><span class="line">    : <span class="built_in">void</span> <span class="number">0</span></span><br><span class="line">  effect.<span class="property">onTrigger</span> = instance.<span class="property">rtg</span></span><br><span class="line">    ? <span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">invokeArrayFns</span>(instance.<span class="property">rtg</span>!, e)</span><br><span class="line">    : <span class="built_in">void</span> <span class="number">0</span></span><br><span class="line">  update.<span class="property">ownerInstance</span> = instance</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">update</span>()</span><br></pre></td></tr></table></figure>

<h3 id="05-æ€»ç»“ã€‚"><a href="#05-æ€»ç»“ã€‚" class="headerlink" title="05. æ€»ç»“ã€‚"></a>05. æ€»ç»“ã€‚</h3><p>reactiveEffect æ˜¯å“åº”å¼çš„æ ¸å¿ƒä»£ç ï¼Œæ‰€æœ‰çš„å€¼éƒ½é€šè¿‡ä»–æ¥æ‰§è¡Œå“åº”å¼ï¼Œé€šè¿‡ <code>run</code> or <code>stop</code> æ¥æ§åˆ¶æ‰§è¡Œæˆ–è€…åœæ­¢ã€‚</p>
<p>é€šè¿‡ targetMap æ¥å­˜å‚¨ reactiveEffect.</p>
<p>targetMap &#x3D;&gt; depsMap &#x3D;&gt; Dep &#x3D;&gt; reactiveEffect.</p>
<p>é€šè¿‡ track æ–¹æ³•æ¥åˆ›å»º Depï¼Œå¹¶ä¸”å’Œå½“å‰çš„ reactivEffect äº§ç”Ÿå…³è”ï¼Œ </p>
<p><code>activeEffect.deps.push(dep)</code> </p>
<p><code>dep.add(activeEffect)</code></p>
<p>é€šè¿‡ trigger æ–¹æ³•ï¼Œæ¥æ‰¾åˆ°å¯¹åº”çš„ reactiveEffect, ä¸ä»…ä»…åŒ…å«å½“å‰ key çš„ï¼Œè¿˜åŒ…å«å¯¹ç”¨æ“ä½œç±»å‹çš„ reactiveEffect </p>
<p>ç„¶åç»Ÿä¸€å»è§¦å‘ã€‚</p>

    </div>

    <div class="post-meta">
        <i>
        
            <span>2023-06-21</span>
            
                <span>è¯¥ç¯‡æ–‡ç« è¢« tommy</span>
            
            
                <span>æ‰“ä¸Šæ ‡ç­¾:
                    
                    
                        <a href='/tags/vue3/'>
                            vue3
                        </a>
                    
                        <a href='/tags/effect/'>
                            effect
                        </a>
                    
                </span>
             
             
        
        </i>
    </div>
    <br>
    
    
        
            
    
            <div class="post-footer-pre-next">
                
                    <span>ä¸Šä¸€ç¯‡ï¼š<a href='/2023/06/24/vue_beforeMount_onBeforeMount/'>Vue beforeMount vs onBeforeMount</a></span>
                

                
                    <span class="post-footer-pre-next-last-span-right">ä¸‹ä¸€ç¯‡ï¼š<a href="/2023/06/20/category/">æ–‡ç« ç›®å½•</a>
                    </span>
                
            </div>
    
        
    

    
        
    <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
         
    </div>
    
        

    <div id="waline"></div>
    <script type="module"  >
        import { init } from 'https://npm.elemecdn.com/hexo-theme-a4@latest/source/js/waline.mjs'; 
        function loadWaline() {
            init({
                el: '#waline',
                serverURL: 'walineserver-phi.vercel.app',
                lang: 'zh-CN',
                dark: 'body[class~="dark-mode"]',
                requiredMeta: ['nick','mail'], // cannot customize by theme config, change it yourself
                search: false, // ç¦æ­¢è¡¨æƒ…åŒ…æœç´¢
                reaction: false, // å¯¹æ–‡ç« æ‰“åˆ†
                pageview: false, // æµè§ˆé‡ç»Ÿè®¡
                comment: false, // è¯„è®ºæ•°ç»Ÿè®¡

                locale: {
                    placeholder: 'ç•™ä¸‹ä½ çš„è¯„è®ºå§ã€‚', 
                    sofa: ''
                },
            });
            
        }
        window.addEventListener('DOMContentLoaded', loadWaline);
    </script>



    
    
    
    </div>


     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
            Â© 1949-2023 China 

            
                

            
        </span>
       
    
</div>



<!--è¿™æ˜¯æŒ‡ä¸€æ¡çº¿å¾€ä¸‹çš„å†…å®¹-->
<div class="footer-last">
    
            <span>ç¥ä»™æ ‘æš´é¾™æˆ˜å£«</span>
            
                <span class="footer-last-span-right"><i>æœ¬ç«™ç”±<a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/index.html">Hexo</a>é©±åŠ¨ï½œä½¿ç”¨<a target="_blank" rel="noopener" href="https://github.com/HiNinoJay/hexo-theme-A4">Hexo-theme-A4</a>ä¸»é¢˜</i></span>
            
    
</div>


    
        
<script src="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/js/highlight.min.js"></script>

        
<script src="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/js/highlightjs-line-numbers.js"></script>


        
<script src="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/js/randomHeaderContent.js"></script>

        <!--å›åˆ°é¡¶éƒ¨æŒ‰é’®-->
        
            
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

            
<script src="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/js/returnToTop.js"></script>

        
        
        <!--ç›®å½•-->
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
            
<script src="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/js/toc.js"></script>

        
    




<script src="/js/lightgallery/lightgallery.umd.min.js"></script>



<script src="/js/lightgallery/plugins/lg-thumbnail.umd.min.js"></script>



<script src="/js/lightgallery/plugins/lg-fullscreen.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-autoplay.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-zoom.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-rotate.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-paper.umd.min.js"></script>




<script type="text/javascript">
     
    if (typeof lightGallery !== "undefined") {
        var options1 = {
            selector: '.gallery-item',
            plugins: [lgThumbnail, lgFullscreen, lgAutoplay, lgZoom, lgRotate, lgPager], // å¯ç”¨æ’ä»¶
            thumbnail: true,          // æ˜¾ç¤ºç¼©ç•¥å›¾
            zoom: true,               // å¯ç”¨ç¼©æ”¾åŠŸ
            rotate: true,             // å¯ç”¨æ—‹è½¬åŠŸèƒ½èƒ½
            autoplay: true,        // å¯ç”¨è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½
            fullScreen: true,      // å¯ç”¨å…¨å±åŠŸèƒ½
            pager: false, //é¡µç ,
            zoomFromOrigin: true,   // ä»åŸå§‹ä½ç½®ç¼©æ”¾
            actualSize: true,       // å¯ç”¨æŸ¥çœ‹å®é™…å¤§å°çš„åŠŸèƒ½
            enableZoomAfter: 300,    // å»¶è¿Ÿç¼©æ”¾ï¼Œç¡®ä¿å›¾ç‰‡åŠ è½½å®Œæˆåå¯ç¼©æ”¾
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options1); // ä¿®å¤é€‰æ‹©å™¨
    }
    
</script>


    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> 

                </div>
            
            
                <!-- å›åˆ°é¡¶éƒ¨çš„æŒ‰é’®-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
            
                <!-- è¿”å›çš„æŒ‰é’®-->  
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>
</html>